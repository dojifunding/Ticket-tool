<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <a href="/projects" class="back-link">‚Üê <%= t.nav_projects %></a>
    <h1 class="page-title">
      <span class="project-color-dot" style="background-color: <%= project.color %>"></span>
      <%= project.name %>
    </h1>
    <p class="page-subtitle"><%= project.code %> ‚Äî <%= t.board_subtitle %></p>
  </div>
  <button class="btn btn-primary" onclick="openNewTaskModal()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
    <%= t.board_new_task %>
  </button>
</div>

<div class="kanban-board" id="kanbanBoard">
  <% const statusLabels = { backlog: t.status_backlog, todo: t.status_todo, in_progress: t.status_in_progress, review: t.status_review, done: t.status_done };
     const statusColors = { backlog: '#64748b', todo: '#6366f1', in_progress: '#f59e0b', review: '#8b5cf6', done: '#10b981' };
     Object.entries(columns).forEach(([status, tasks]) => { %>
  <div class="kanban-column" data-status="<%= status %>">
    <div class="kanban-column-header">
      <div class="column-title">
        <span class="column-dot" style="background-color: <%= statusColors[status] %>"></span>
        <span><%= statusLabels[status] %></span>
        <span class="column-count"><%= tasks.length %></span>
      </div>
    </div>
    <div class="kanban-cards" data-status="<%= status %>"
         ondrop="dropTask(event)" ondragover="event.preventDefault(); this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')">
      <% tasks.forEach(task => { %>
        <div class="kanban-card" draggable="true" data-task-id="<%= task.id %>"
             ondragstart="dragTask(event, <%= task.id %>)">
          <div class="card-top">
            <span class="task-type task-type-<%= task.type %>">
              <%= task.type === 'bug' ? 'üêõ' : task.type === 'feature' ? '‚ú®' : task.type === 'escalation' ? 'üî∫' : task.type === 'improvement' ? 'üí°' : 'üìã' %>
              <%= task.type %>
            </span>
            <span class="priority-dot priority-<%= task.priority %>" title="<%= task.priority %>"></span>
          </div>
          <a href="/projects/<%= project.id %>/tasks/<%= task.id %>" class="card-title"><%= task.title %></a>
          <% if (task.assignee_name) { %>
            <div class="card-assignee">
              <div class="avatar avatar-xs" style="background-color: <%= task.assignee_color %>"><%= task.assignee_name.charAt(0) %></div>
              <span><%= task.assignee_name %></span>
            </div>
          <% } %>
          <% if (task.due_date) { %>
            <div class="card-due <% if (new Date(task.due_date) < new Date()) { %>overdue<% } %>">
              üìÖ <%= new Date(task.due_date).toLocaleDateString(dateLocale) %>
            </div>
          <% } %>
        </div>
      <% }) %>
    </div>
  </div>
  <% }) %>
</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="newTaskModal">
  <div class="modal">
    <div class="modal-header">
      <h2><%= t.board_modal_title %></h2>
      <button class="modal-close" onclick="closeModal('newTaskModal')">√ó</button>
    </div>
    <form method="POST" action="/projects/<%= project.id %>/tasks">
      <div class="modal-body">
        <div class="form-group">
          <label for="taskTitle"><%= t.board_task_title %></label>
          <input type="text" id="taskTitle" name="title" required placeholder="<%= t.board_task_title_placeholder %>">
        </div>
        <div class="form-group">
          <label for="taskDesc"><%= t.board_task_description %></label>
          <textarea id="taskDesc" name="description" rows="3" placeholder="<%= t.board_task_desc_placeholder %>"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="taskStatus"><%= t.label_status %></label>
            <select id="taskStatus" name="status">
              <option value="backlog"><%= t.status_backlog %></option>
              <option value="todo" selected><%= t.status_todo %></option>
              <option value="in_progress"><%= t.status_in_progress %></option>
              <option value="review"><%= t.status_review %></option>
            </select>
          </div>
          <div class="form-group">
            <label for="taskPriority"><%= t.label_priority %></label>
            <select id="taskPriority" name="priority">
              <option value="low"><%= t.priority_low %></option>
              <option value="medium" selected><%= t.priority_medium %></option>
              <option value="high"><%= t.priority_high %></option>
              <option value="critical"><%= t.priority_critical %></option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="taskType"><%= t.label_type %></label>
            <select id="taskType" name="type">
              <option value="task"><%= t.type_task %></option>
              <option value="bug"><%= t.type_bug %></option>
              <option value="feature"><%= t.type_feature %></option>
              <option value="improvement"><%= t.type_improvement %></option>
            </select>
          </div>
          <div class="form-group">
            <label for="taskAssigned"><%= t.label_assigned_to %></label>
            <select id="taskAssigned" name="assigned_to">
              <option value=""><%= t.not_assigned %></option>
              <% developers.forEach(dev => { %>
                <option value="<%= dev.id %>"><%= dev.full_name %></option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="taskDue"><%= t.label_due_date %></label>
          <input type="date" id="taskDue" name="due_date">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeModal('newTaskModal')"><%= t.cancel %></button>
        <button type="submit" class="btn btn-primary"><%= t.board_task_create %></button>
      </div>
    </form>
  </div>
</div>

<script>
function openNewTaskModal() { document.getElementById('newTaskModal').classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function dragTask(e, taskId) { e.dataTransfer.setData('text/plain', taskId); e.target.classList.add('dragging'); }
function dropTask(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const taskId = e.dataTransfer.getData('text/plain');
  const newStatus = e.currentTarget.dataset.status;
  const card = document.querySelector('[data-task-id="' + taskId + '"]');
  if (card) { card.classList.remove('dragging'); e.currentTarget.appendChild(card); }
  fetch('/api/tasks/' + taskId + '/status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
}
document.getElementById('newTaskModal').addEventListener('click', function(e) { if (e.target === this) closeModal('newTaskModal'); });
</script>

<%- include('../partials/foot') %>
