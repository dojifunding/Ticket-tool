<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <a href="/projects/<%= task.project_id %>/board" class="back-link">‚Üê <%= task.project_code %> Board</a>
    <div class="task-detail-title">
      <span class="task-type task-type-<%= task.type %>">
        <%= task.type === 'bug' ? 'üêõ' : task.type === 'feature' ? '‚ú®' : task.type === 'escalation' ? 'üî∫' : task.type === 'improvement' ? 'üí°' : 'üìã' %>
      </span>
      <h1 class="page-title"><%= task.title %></h1>
    </div>
  </div>
</div>

<div class="detail-layout">
  <!-- Main Content -->
  <div class="detail-main">
    <% if (sourceTicket) { %>
      <div class="escalation-banner">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        Escalad√© depuis le ticket
        <% if (user.role === 'admin' || user.role === 'support') { %>
          <a href="/tickets/<%= sourceTicket.id %>"><%= sourceTicket.reference %> ‚Äî <%= sourceTicket.subject %></a>
        <% } else { %>
          <strong><%= sourceTicket.reference %> ‚Äî <%= sourceTicket.subject %></strong>
        <% } %>
      </div>
    <% } %>

    <!-- Description -->
    <div class="detail-section">
      <h3>Description</h3>
      <div class="detail-description">
        <%= task.description || 'Aucune description fournie.' %>
      </div>
    </div>

    <!-- Comments -->
    <div class="detail-section">
      <h3>Commentaires (<%= comments.length %>)</h3>
      <div class="comments-list" id="commentsList">
        <% comments.forEach(comment => { %>
          <div class="comment">
            <div class="avatar avatar-sm" style="background-color: <%= comment.avatar_color %>"><%= comment.full_name.charAt(0) %></div>
            <div class="comment-body">
              <div class="comment-header">
                <strong><%= comment.full_name %></strong>
                <time><%= new Date(comment.created_at).toLocaleString('fr-FR') %></time>
              </div>
              <div class="comment-content"><%= comment.content %></div>
            </div>
          </div>
        <% }) %>
        <% if (comments.length === 0) { %>
          <p class="text-muted">Aucun commentaire pour le moment.</p>
        <% } %>
      </div>

      <div class="comment-form">
        <div class="avatar avatar-sm" style="background-color: <%= user.avatar_color %>"><%= user.full_name.charAt(0) %></div>
        <div class="comment-input-wrapper">
          <textarea id="commentInput" placeholder="√âcrire un commentaire..." rows="2"></textarea>
          <button class="btn btn-primary btn-sm" onclick="sendComment()">Envoyer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="detail-sidebar">
    <form method="POST" action="/projects/<%= task.project_id %>/tasks/<%= task.id %>/update" class="sidebar-form">
      <div class="sidebar-field">
        <label>Statut</label>
        <select name="status" class="status-select status-<%= task.status %>">
          <option value="backlog" <%= task.status === 'backlog' ? 'selected' : '' %>>Backlog</option>
          <option value="todo" <%= task.status === 'todo' ? 'selected' : '' %>>√Ä faire</option>
          <option value="in_progress" <%= task.status === 'in_progress' ? 'selected' : '' %>>En cours</option>
          <option value="review" <%= task.status === 'review' ? 'selected' : '' %>>En revue</option>
          <option value="done" <%= task.status === 'done' ? 'selected' : '' %>>Termin√©</option>
        </select>
      </div>
      <div class="sidebar-field">
        <label>Priorit√©</label>
        <select name="priority">
          <option value="low" <%= task.priority === 'low' ? 'selected' : '' %>>üü¢ Basse</option>
          <option value="medium" <%= task.priority === 'medium' ? 'selected' : '' %>>üü° Moyenne</option>
          <option value="high" <%= task.priority === 'high' ? 'selected' : '' %>>üü† Haute</option>
          <option value="critical" <%= task.priority === 'critical' ? 'selected' : '' %>>üî¥ Critique</option>
        </select>
      </div>
      <div class="sidebar-field">
        <label>Type</label>
        <select name="type">
          <option value="task" <%= task.type === 'task' ? 'selected' : '' %>>üìã T√¢che</option>
          <option value="bug" <%= task.type === 'bug' ? 'selected' : '' %>>üêõ Bug</option>
          <option value="feature" <%= task.type === 'feature' ? 'selected' : '' %>>‚ú® Feature</option>
          <option value="improvement" <%= task.type === 'improvement' ? 'selected' : '' %>>üí° Am√©lioration</option>
          <option value="escalation" <%= task.type === 'escalation' ? 'selected' : '' %>>üî∫ Escalade</option>
        </select>
      </div>
      <div class="sidebar-field">
        <label>Assign√© √†</label>
        <select name="assigned_to">
          <option value="">Non assign√©</option>
          <% developers.forEach(dev => { %>
            <option value="<%= dev.id %>" <%= task.assigned_to === dev.id ? 'selected' : '' %>><%= dev.full_name %></option>
          <% }) %>
        </select>
      </div>
      <div class="sidebar-field">
        <label>Date limite</label>
        <input type="date" name="due_date" value="<%= task.due_date || '' %>">
      </div>

      <input type="hidden" name="title" value="<%= task.title %>">
      <input type="hidden" name="description" value="<%= task.description || '' %>">

      <button type="submit" class="btn btn-primary btn-full">Mettre √† jour</button>
    </form>

    <div class="sidebar-meta">
      <div class="meta-item">
        <span class="meta-label">Cr√©√© par</span>
        <span><%= task.creator_name %></span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Cr√©√© le</span>
        <span><%= new Date(task.created_at).toLocaleDateString('fr-FR') %></span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Modifi√© le</span>
        <span><%= new Date(task.updated_at).toLocaleDateString('fr-FR') %></span>
      </div>
    </div>

    <form method="POST" action="/projects/<%= task.project_id %>/tasks/<%= task.id %>/delete"
          onsubmit="return confirm('Supprimer cette t√¢che ?')">
      <button type="submit" class="btn btn-danger btn-full">Supprimer la t√¢che</button>
    </form>
  </div>
</div>

<script>
const taskId = <%= task.id %>;
function sendComment() {
  const input = document.getElementById('commentInput');
  const content = input.value.trim();
  if (!content) return;
  const socket = io();
  socket.emit('task:comment', { taskId, content });
  input.value = '';
}
// Listen for new comments in real-time
if (typeof io !== 'undefined') {
  const socket = io();
  socket.on('task:newComment', (data) => {
    if (data.taskId === taskId) {
      const c = data.comment;
      const list = document.getElementById('commentsList');
      const emptyMsg = list.querySelector('.text-muted');
      if (emptyMsg) emptyMsg.remove();
      const div = document.createElement('div');
      div.className = 'comment comment-new';
      div.innerHTML = `
        <div class="avatar avatar-sm" style="background-color: ${c.avatar_color}">${c.full_name.charAt(0)}</div>
        <div class="comment-body">
          <div class="comment-header"><strong>${c.full_name}</strong><time>√Ä l'instant</time></div>
          <div class="comment-content">${c.content}</div>
        </div>
      `;
      list.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }
  });
}
</script>

<%- include('../partials/foot') %>
