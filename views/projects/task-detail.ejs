<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <a href="/projects/<%= task.project_id %>/board" class="back-link">‚Üê <%= task.project_code %> <%= t.task_back_board %></a>
    <div class="task-detail-title">
      <span class="task-type task-type-<%= task.type %>">
        <%= task.type === 'bug' ? 'üêõ' : task.type === 'feature' ? '‚ú®' : task.type === 'escalation' ? 'üî∫' : task.type === 'improvement' ? 'üí°' : 'üìã' %>
      </span>
      <h1 class="page-title"><%= task.title %></h1>
    </div>
  </div>
</div>

<div class="detail-layout">
  <div class="detail-main">
    <% if (sourceTicket) { %>
      <div class="escalation-banner">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        <%= t.task_escalated_from %>
        <% if (user.role === 'admin' || user.role === 'support') { %>
          <a href="/tickets/<%= sourceTicket.id %>"><%= sourceTicket.reference %> ‚Äî <%= sourceTicket.subject %></a>
        <% } else { %>
          <strong><%= sourceTicket.reference %> ‚Äî <%= sourceTicket.subject %></strong>
        <% } %>
      </div>
    <% } %>

    <div class="detail-section">
      <h3><%= t.task_description %></h3>
      <div class="detail-description"><%= task.description || t.no_description_provided %></div>
    </div>

    <div class="detail-section">
      <h3><%= t.task_comments %> (<%= comments.length %>)</h3>
      <div class="comments-list" id="commentsList">
        <% comments.forEach(comment => { %>
          <div class="comment">
            <div class="avatar avatar-sm" style="background-color: <%= comment.avatar_color %>"><%= comment.full_name.charAt(0) %></div>
            <div class="comment-body">
              <div class="comment-header">
                <strong><%= comment.full_name %></strong>
                <time><%= new Date(comment.created_at).toLocaleString(dateLocale) %></time>
              </div>
              <div class="comment-content"><%= comment.content %></div>
            </div>
          </div>
        <% }) %>
        <% if (comments.length === 0) { %>
          <p class="text-muted"><%= t.task_no_comments %></p>
        <% } %>
      </div>

      <div class="comment-form">
        <div class="avatar avatar-sm" style="background-color: <%= user.avatar_color %>"><%= user.full_name.charAt(0) %></div>
        <div class="comment-input-wrapper">
          <textarea id="commentInput" placeholder="<%= t.task_comment_placeholder %>" rows="2"></textarea>
          <button class="btn btn-primary btn-sm" onclick="sendComment()"><%= t.send %></button>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-sidebar">
    <form method="POST" action="/projects/<%= task.project_id %>/tasks/<%= task.id %>/update" class="sidebar-form">
      <div class="sidebar-field">
        <label><%= t.label_status %></label>
        <select name="status" class="status-select status-<%= task.status %>">
          <option value="backlog" <%= task.status === 'backlog' ? 'selected' : '' %>><%= t.status_backlog %></option>
          <option value="todo" <%= task.status === 'todo' ? 'selected' : '' %>><%= t.status_todo %></option>
          <option value="in_progress" <%= task.status === 'in_progress' ? 'selected' : '' %>><%= t.status_in_progress %></option>
          <option value="review" <%= task.status === 'review' ? 'selected' : '' %>><%= t.status_review %></option>
          <option value="done" <%= task.status === 'done' ? 'selected' : '' %>><%= t.status_done %></option>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_priority %></label>
        <select name="priority">
          <option value="low" <%= task.priority === 'low' ? 'selected' : '' %>><%= t.priority_low %></option>
          <option value="medium" <%= task.priority === 'medium' ? 'selected' : '' %>><%= t.priority_medium %></option>
          <option value="high" <%= task.priority === 'high' ? 'selected' : '' %>><%= t.priority_high %></option>
          <option value="critical" <%= task.priority === 'critical' ? 'selected' : '' %>><%= t.priority_critical %></option>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_type %></label>
        <select name="type">
          <option value="task" <%= task.type === 'task' ? 'selected' : '' %>><%= t.type_task %></option>
          <option value="bug" <%= task.type === 'bug' ? 'selected' : '' %>><%= t.type_bug %></option>
          <option value="feature" <%= task.type === 'feature' ? 'selected' : '' %>><%= t.type_feature %></option>
          <option value="improvement" <%= task.type === 'improvement' ? 'selected' : '' %>><%= t.type_improvement %></option>
          <option value="escalation" <%= task.type === 'escalation' ? 'selected' : '' %>><%= t.type_escalation %></option>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_assigned_to %></label>
        <select name="assigned_to">
          <option value=""><%= t.not_assigned %></option>
          <% developers.forEach(dev => { %>
            <option value="<%= dev.id %>" <%= task.assigned_to === dev.id ? 'selected' : '' %>><%= dev.full_name %></option>
          <% }) %>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_due_date %></label>
        <input type="date" name="due_date" value="<%= task.due_date || '' %>">
      </div>
      <input type="hidden" name="title" value="<%= task.title %>">
      <input type="hidden" name="description" value="<%= task.description || '' %>">
      <button type="submit" class="btn btn-primary btn-full"><%= t.update %></button>
    </form>

    <div class="sidebar-meta">
      <div class="meta-item">
        <span class="meta-label"><%= t.label_created_by %></span>
        <span><%= task.creator_name %></span>
      </div>
      <div class="meta-item">
        <span class="meta-label"><%= t.label_created_at %></span>
        <span><%= new Date(task.created_at).toLocaleDateString(dateLocale) %></span>
      </div>
      <div class="meta-item">
        <span class="meta-label"><%= t.label_updated_at %></span>
        <span><%= new Date(task.updated_at).toLocaleDateString(dateLocale) %></span>
      </div>
    </div>

    <form method="POST" action="/projects/<%= task.project_id %>/tasks/<%= task.id %>/delete"
          onsubmit="return confirm('<%= t.task_delete_confirm %>')">
      <button type="submit" class="btn btn-danger btn-full"><%= t.task_delete %></button>
    </form>
  </div>
</div>

<script>
const taskId = <%= task.id %>;
function sendComment() {
  const input = document.getElementById('commentInput');
  const content = input.value.trim();
  if (!content) return;
  const socket = io();
  socket.emit('task:comment', { taskId, content });
  input.value = '';
}
if (typeof io !== 'undefined') {
  const socket = io();
  socket.on('task:newComment', (data) => {
    if (data.taskId === taskId) {
      const c = data.comment;
      const list = document.getElementById('commentsList');
      const emptyMsg = list.querySelector('.text-muted');
      if (emptyMsg) emptyMsg.remove();
      const div = document.createElement('div');
      div.className = 'comment comment-new';
      div.innerHTML = '<div class="avatar avatar-sm" style="background-color: ' + c.avatar_color + '">' + c.full_name.charAt(0) + '</div><div class="comment-body"><div class="comment-header"><strong>' + c.full_name + '</strong><time><%= t.just_now %></time></div><div class="comment-content">' + c.content + '</div></div>';
      list.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }
  });
}
</script>

<%- include('../partials/foot') %>
