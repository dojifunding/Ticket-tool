<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <h1 class="page-title"><%= t.tickets_title %></h1>
    <p class="page-subtitle"><%= stats.total %> <%= t.tickets_count_suffix %></p>
  </div>
  <a href="/tickets/new" class="btn btn-primary">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
    <%= t.tickets_new %>
  </a>
</div>

<!-- Stats Cards -->
<div class="stats-row">
  <div class="stat-card stat-open">
    <div class="stat-value"><%= stats.open %></div>
    <div class="stat-label"><%= t.tickets_stat_open %></div>
  </div>
  <div class="stat-card stat-progress">
    <div class="stat-value"><%= stats.in_progress %></div>
    <div class="stat-label"><%= t.tickets_stat_progress %></div>
  </div>
  <div class="stat-card stat-waiting">
    <div class="stat-value"><%= stats.waiting %></div>
    <div class="stat-label"><%= t.tickets_stat_waiting %></div>
  </div>
  <div class="stat-card stat-resolved">
    <div class="stat-value"><%= stats.archived %></div>
    <div class="stat-label"><%= t.tickets_stat_archived %></div>
  </div>
</div>

<!-- Filters -->
<div class="filters-bar">
  <form method="GET" action="/tickets" class="filters-form">
    <select name="status" onchange="this.form.submit()">
      <option value="all"><%= t.tickets_filter_all_status %></option>
      <option value="open" <%= filters.status === 'open' ? 'selected' : '' %>><%= t.tstatus_open %></option>
      <option value="in_progress" <%= filters.status === 'in_progress' ? 'selected' : '' %>><%= t.tstatus_in_progress %></option>
      <option value="waiting" <%= filters.status === 'waiting' ? 'selected' : '' %>><%= t.tstatus_waiting %></option>
      <option value="archived" <%= filters.status === 'archived' ? 'selected' : '' %>>ğŸ“¦ <%= t.tickets_filter_archived %></option>
    </select>
    <select name="priority" onchange="this.form.submit()">
      <option value="all"><%= t.tickets_filter_all_priority %></option>
      <option value="urgent" <%= filters.priority === 'urgent' ? 'selected' : '' %>><%= t.priority_urgent %></option>
      <option value="high" <%= filters.priority === 'high' ? 'selected' : '' %>><%= t.priority_high %></option>
      <option value="medium" <%= filters.priority === 'medium' ? 'selected' : '' %>><%= t.priority_medium %></option>
      <option value="low" <%= filters.priority === 'low' ? 'selected' : '' %>><%= t.priority_low %></option>
    </select>
    <select name="assigned" onchange="this.form.submit()">
      <option value="all"><%= t.tickets_filter_all_agents %></option>
      <option value="me" <%= filters.assigned === 'me' ? 'selected' : '' %>><%= t.tickets_filter_my %></option>
      <option value="unassigned" <%= filters.assigned === 'unassigned' ? 'selected' : '' %>><%= t.tickets_filter_unassigned %></option>
    </select>
    <% if (typeof companies !== 'undefined' && companies.length > 0) { %>
      <select name="company" onchange="this.form.submit()">
        <option value="all">ğŸ¢ Toutes les entreprises</option>
        <option value="none" <%= filters.company === 'none' ? 'selected' : '' %>>â€” Sans entreprise â€”</option>
        <% companies.forEach(c => { %>
          <option value="<%= c.id %>" <%= filters.company == c.id ? 'selected' : '' %>><%= c.name %></option>
        <% }) %>
      </select>
    <% } %>
    <div class="search-filter">
      <input type="text" name="search" value="<%= filters.search || '' %>" placeholder="<%= t.tickets_filter_search %>">
      <button type="submit" class="btn btn-sm btn-ghost">ğŸ”</button>
    </div>
  </form>
</div>

<!-- Tickets Table -->
<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th><%= t.tickets_col_ref %></th>
        <th><%= t.tickets_col_subject %></th>
        <th><%= t.tickets_col_client %></th>
        <th>ğŸ¢</th>
        <th><%= t.tickets_col_priority %></th>
        <th><%= t.tickets_col_status %></th>
        <th><%= t.tickets_col_assigned %></th>
        <th><%= t.tickets_col_updated %></th>
      </tr>
    </thead>
    <tbody>
      <% tickets.forEach(ticket => { %>
        <tr class="ticket-row" onclick="window.location='/tickets/<%= ticket.id %>'">
          <td><span class="ticket-ref"><%= ticket.reference %></span></td>
          <td>
            <div class="ticket-subject">
              <% if (ticket.escalated_to_task) { %><span class="escalation-tag" title="Escalated">ğŸ”º</span><% } %>
              <%= ticket.subject %>
            </div>
            <div class="ticket-category"><%= ticket.category %></div>
          </td>
          <td><%= ticket.client_name || 'â€”' %></td>
          <td><% if (ticket.company_name) { %><span class="company-tag" style="background:color-mix(in srgb, <%= ticket.company_color || '#6366f1' %> 10%, transparent);color:<%= ticket.company_color || '#6366f1' %>;border-color:color-mix(in srgb, <%= ticket.company_color || '#6366f1' %> 20%, transparent)"><span class="company-badge-dot" style="background:<%= ticket.company_color || '#6366f1' %>"></span> <%= ticket.company_name %></span><% } else { %><span class="text-muted">â€”</span><% } %></td>
          <td><span class="badge badge-priority-<%= ticket.priority %>"><%= ticket.priority %></span></td>
          <td><span class="badge badge-status-<%= ticket.status %>"><%= ticket.status.replace('_', ' ') %></span></td>
          <td>
            <% if (ticket.assignee_name) { %>
              <div class="assignee-chip">
                <div class="avatar avatar-xs" style="background-color: <%= ticket.assignee_color %>"><%= ticket.assignee_name.charAt(0) %></div>
                <span><%= ticket.assignee_name %></span>
              </div>
            <% } else { %>
              <span class="text-muted"><%= t.not_assigned %></span>
            <% } %>
          </td>
          <td class="text-muted"><%= new Date(ticket.updated_at).toLocaleDateString(dateLocale) %></td>
        </tr>
      <% }) %>
      <% if (tickets.length === 0) { %>
        <tr><td colspan="8" class="empty-table"><%= t.tickets_empty %></td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<%- include('../partials/foot') %>

<script>
// Real-time: auto-refresh when new livechat ticket arrives
if (typeof io !== 'undefined') {
  const sock = io();
  sock.on('livechat:new', () => { window.location.reload(); });
  sock.on('ticket:newMessage', () => {
    // Update badge or subtle indicator â€” simple reload for now
    const badge = document.querySelector('.stat-progress .stat-value');
    if (badge && !badge.dataset.notified) {
      badge.dataset.notified = '1';
      badge.style.animation = 'pulse 0.5s ease 2';
    }
  });
}
</script>
