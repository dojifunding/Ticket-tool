<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <a href="/tickets" class="back-link">â† Tickets</a>
    <div class="ticket-detail-title">
      <span class="ticket-ref-lg"><%= ticket.reference %></span>
      <h1 class="page-title"><%= ticket.subject %></h1>
    </div>
  </div>
</div>

<div class="detail-layout">
  <!-- Main Content -->
  <div class="detail-main">
    <!-- Escalation banner -->
    <% if (escalatedTask) { %>
      <div class="escalation-banner escalation-active">
        ğŸ”º EscaladÃ© vers l'Ã©quipe dÃ©veloppement
        <% if (user.role === 'admin') { %>
          â€” <a href="/projects/<%= escalatedTask.project_id %>/tasks/<%= escalatedTask.id %>">Voir la tÃ¢che dans "<%= escalatedTask.project_name %>"</a>
        <% } else { %>
          â€” Projet: <%= escalatedTask.project_name %> (statut: <%= escalatedTask.status %>)
        <% } %>
      </div>
    <% } %>

    <!-- Ticket Description -->
    <div class="detail-section">
      <h3>Description du problÃ¨me</h3>
      <div class="detail-description ticket-description"><%= ticket.description %></div>
      <div class="ticket-client-info">
        <% if (ticket.client_name) { %>
          <span>ğŸ‘¤ <%= ticket.client_name %></span>
        <% } %>
        <% if (ticket.client_email) { %>
          <span>âœ‰ï¸ <%= ticket.client_email %></span>
        <% } %>
      </div>
    </div>

    <!-- Messages / Conversation -->
    <div class="detail-section">
      <h3>Conversation (<%= messages.length %>)</h3>
      <div class="messages-list" id="messagesList">
        <% messages.forEach(msg => { %>
          <div class="message <%= msg.is_internal ? 'message-internal' : '' %>">
            <div class="avatar avatar-sm" style="background-color: <%= msg.avatar_color %>"><%= msg.full_name.charAt(0) %></div>
            <div class="message-body">
              <div class="message-header">
                <strong><%= msg.full_name %></strong>
                <span class="message-role"><%= msg.user_role %></span>
                <% if (msg.is_internal) { %><span class="internal-badge">Note interne</span><% } %>
                <time><%= new Date(msg.created_at).toLocaleString('fr-FR') %></time>
              </div>
              <div class="message-content"><%= msg.content %></div>
            </div>
          </div>
        <% }) %>
        <% if (messages.length === 0) { %>
          <p class="text-muted">Aucun message. Ajoutez le premier message ci-dessous.</p>
        <% } %>
      </div>

      <!-- Message Input -->
      <div class="message-form">
        <div class="avatar avatar-sm" style="background-color: <%= user.avatar_color %>"><%= user.full_name.charAt(0) %></div>
        <div class="message-input-wrapper">
          <textarea id="messageInput" placeholder="Ã‰crire un message..." rows="3"></textarea>
          <div class="message-actions">
            <label class="internal-toggle">
              <input type="checkbox" id="isInternal">
              <span>Note interne (invisible pour le client)</span>
            </label>
            <button class="btn btn-primary btn-sm" onclick="sendMessage()">
              Envoyer
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="detail-sidebar">
    <form method="POST" action="/tickets/<%= ticket.id %>/update" class="sidebar-form">
      <div class="sidebar-field">
        <label>Statut</label>
        <select name="status" class="status-select">
          <option value="open" <%= ticket.status === 'open' ? 'selected' : '' %>>ğŸŸ¢ Ouvert</option>
          <option value="in_progress" <%= ticket.status === 'in_progress' ? 'selected' : '' %>>ğŸ”µ En cours</option>
          <option value="waiting" <%= ticket.status === 'waiting' ? 'selected' : '' %>>ğŸŸ¡ En attente</option>
          <option value="resolved" <%= ticket.status === 'resolved' ? 'selected' : '' %>>âœ… RÃ©solu</option>
          <option value="closed" <%= ticket.status === 'closed' ? 'selected' : '' %>>â¬› FermÃ©</option>
        </select>
      </div>
      <div class="sidebar-field">
        <label>PrioritÃ©</label>
        <select name="priority">
          <option value="low" <%= ticket.priority === 'low' ? 'selected' : '' %>>ğŸŸ¢ Basse</option>
          <option value="medium" <%= ticket.priority === 'medium' ? 'selected' : '' %>>ğŸŸ¡ Moyenne</option>
          <option value="high" <%= ticket.priority === 'high' ? 'selected' : '' %>>ğŸŸ  Haute</option>
          <option value="urgent" <%= ticket.priority === 'urgent' ? 'selected' : '' %>>ğŸ”´ Urgent</option>
        </select>
      </div>
      <div class="sidebar-field">
        <label>CatÃ©gorie</label>
        <select name="category">
          <option value="general" <%= ticket.category === 'general' ? 'selected' : '' %>>GÃ©nÃ©ral</option>
          <option value="bug" <%= ticket.category === 'bug' ? 'selected' : '' %>>Bug</option>
          <option value="question" <%= ticket.category === 'question' ? 'selected' : '' %>>Question</option>
          <option value="feature_request" <%= ticket.category === 'feature_request' ? 'selected' : '' %>>Demande</option>
          <option value="account" <%= ticket.category === 'account' ? 'selected' : '' %>>Compte</option>
          <option value="billing" <%= ticket.category === 'billing' ? 'selected' : '' %>>Facturation</option>
          <option value="other" <%= ticket.category === 'other' ? 'selected' : '' %>>Autre</option>
        </select>
      </div>
      <div class="sidebar-field">
        <label>AssignÃ© Ã </label>
        <select name="assigned_to">
          <option value="">Non assignÃ©</option>
          <% agents.forEach(a => { %>
            <option value="<%= a.id %>" <%= ticket.assigned_to === a.id ? 'selected' : '' %>><%= a.full_name %></option>
          <% }) %>
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-full">Mettre Ã  jour</button>
    </form>

    <div class="sidebar-meta">
      <div class="meta-item">
        <span class="meta-label">CrÃ©Ã© par</span>
        <span><%= ticket.creator_name %></span>
      </div>
      <div class="meta-item">
        <span class="meta-label">CrÃ©Ã© le</span>
        <span><%= new Date(ticket.created_at).toLocaleString('fr-FR') %></span>
      </div>
      <% if (ticket.resolved_at) { %>
        <div class="meta-item">
          <span class="meta-label">RÃ©solu le</span>
          <span><%= new Date(ticket.resolved_at).toLocaleString('fr-FR') %></span>
        </div>
      <% } %>
    </div>

    <!-- Escalation -->
    <% if (!escalatedTask) { %>
      <div class="escalation-section">
        <h4>ğŸ”º Escalader aux dÃ©veloppeurs</h4>
        <p class="text-muted text-sm">Signaler ce problÃ¨me Ã  l'Ã©quipe technique</p>
        <form method="POST" action="/tickets/<%= ticket.id %>/escalate" class="escalation-form">
          <div class="form-group">
            <label>Projet cible *</label>
            <select name="project_id" required>
              <option value="">Choisir un projet</option>
              <% projects.forEach(p => { %>
                <option value="<%= p.id %>"><%= p.code %> â€” <%= p.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Titre de la tÃ¢che</label>
            <input type="text" name="title" value="[Escalade] <%= ticket.subject %>" placeholder="Titre...">
          </div>
          <div class="form-group">
            <label>PrioritÃ©</label>
            <select name="priority">
              <option value="medium">Moyenne</option>
              <option value="high" <%= ticket.priority === 'high' || ticket.priority === 'urgent' ? 'selected' : '' %>>Haute</option>
              <option value="critical" <%= ticket.priority === 'urgent' ? 'selected' : '' %>>Critique</option>
            </select>
          </div>
          <button type="submit" class="btn btn-warning btn-full"
                  onclick="return confirm('Escalader ce ticket Ã  l\'Ã©quipe de dÃ©veloppement ?')">
            ğŸ”º Escalader
          </button>
        </form>
      </div>
    <% } %>
  </div>
</div>

<script>
const ticketId = <%= ticket.id %>;
function sendMessage() {
  const input = document.getElementById('messageInput');
  const content = input.value.trim();
  if (!content) return;
  const isInternal = document.getElementById('isInternal').checked;
  const socket = io();
  socket.emit('ticket:message', { ticketId, content, isInternal });
  input.value = '';
}
// Real-time messages
if (typeof io !== 'undefined') {
  const socket = io();
  socket.on('ticket:newMessage', (data) => {
    if (data.ticketId === ticketId) {
      const m = data.message;
      const list = document.getElementById('messagesList');
      const emptyMsg = list.querySelector('.text-muted');
      if (emptyMsg) emptyMsg.remove();
      const div = document.createElement('div');
      div.className = 'message message-new' + (m.is_internal ? ' message-internal' : '');
      div.innerHTML = `
        <div class="avatar avatar-sm" style="background-color: ${m.avatar_color}">${m.full_name.charAt(0)}</div>
        <div class="message-body">
          <div class="message-header">
            <strong>${m.full_name}</strong>
            <span class="message-role">${m.user_role}</span>
            ${m.is_internal ? '<span class="internal-badge">Note interne</span>' : ''}
            <time>Ã€ l'instant</time>
          </div>
          <div class="message-content">${m.content}</div>
        </div>
      `;
      list.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }
  });
}
// Ctrl+Enter to send
document.getElementById('messageInput').addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'Enter') sendMessage();
});
</script>

<%- include('../partials/foot') %>
