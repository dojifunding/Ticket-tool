<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <a href="/tickets" class="back-link"><%= t.ticket_back %></a>
    <div class="ticket-detail-title">
      <span class="ticket-ref-lg"><%= ticket.reference %></span>
      <% if (chatSession) { %><span class="livechat-badge"><%= t.chat_livechat_badge %></span><% } %>
      <h1 class="page-title"><%= ticket.subject %></h1>
    </div>
  </div>
</div>

<div class="detail-layout">
  <div class="detail-main">
    <% if (escalatedTask) { %>
      <div class="escalation-banner escalation-active">
        ğŸ”º <%= t.ticket_escalated_to_dev %>
        <% if (user.role === 'admin') { %>
          â€” <a href="/projects/<%= escalatedTask.project_id %>/tasks/<%= escalatedTask.id %>"><%= t.ticket_see_task %> "<%= escalatedTask.project_name %>"</a>
        <% } else { %>
          â€” <%= t.ticket_project_status %> <%= escalatedTask.project_name %> (<%= t.ticket_status_label %> <%= escalatedTask.status %>)
        <% } %>
      </div>
    <% } %>

    <div class="detail-section">
      <h3><%= t.ticket_description_title %></h3>
      <div class="detail-description ticket-description"><%= ticket.description %></div>
      <div class="ticket-client-info">
        <% if (ticket.client_name) { %><span>ğŸ‘¤ <%= ticket.client_name %></span><% } %>
        <% if (ticket.client_email) { %><span>âœ‰ï¸ <%= ticket.client_email %></span><% } %>
      </div>
    </div>

    <div class="detail-section">
      <h3><%= t.ticket_conversation %> (<%= messages.length %>)</h3>
      <div class="messages-list" id="messagesList">
        <% messages.forEach(msg => { %>
          <div class="message <%= msg.is_internal ? 'message-internal' : '' %>">
            <div class="avatar avatar-sm" style="background-color: <%= msg.avatar_color %>"><%= msg.full_name.charAt(0) %></div>
            <div class="message-body">
              <div class="message-header">
                <strong><%= msg.full_name %></strong>
                <span class="message-role"><%= msg.user_role %></span>
                <% if (msg.is_internal) { %><span class="internal-badge"><%= t.ticket_internal_badge %></span><% } %>
                <time><%= new Date(msg.created_at).toLocaleString(dateLocale) %></time>
              </div>
              <div class="message-content"><%= msg.content %></div>
            </div>
          </div>
        <% }) %>
        <% if (messages.length === 0) { %>
          <p class="text-muted"><%= t.ticket_no_messages %></p>
        <% } %>
      </div>

      <div class="message-form">
        <div class="avatar avatar-sm" style="background-color: <%= user.avatar_color %>"><%= user.full_name.charAt(0) %></div>
        <div class="message-input-wrapper">
          <textarea id="messageInput" placeholder="<%= t.ticket_message_placeholder %>" rows="3"></textarea>
          <div class="message-actions">
            <label class="internal-toggle">
              <input type="checkbox" id="isInternal">
              <span><%= t.ticket_internal_note %></span>
            </label>
            <div class="msg-action-btns">
              <button class="btn btn-ghost btn-sm ai-suggest-btn" onclick="aiSuggestReply()" id="aiSuggestBtn" title="<%= t.ticket_ai_suggest %>">
                ğŸ¤– <%= t.ticket_ai_suggest %>
              </button>
              <button class="btn btn-primary btn-sm" onclick="sendMessage()">
                <%= t.send %>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-sidebar">
    <form method="POST" action="/tickets/<%= ticket.id %>/update" class="sidebar-form">
      <div class="sidebar-field">
        <label><%= t.label_status %></label>
        <select name="status" class="status-select">
          <option value="open" <%= ticket.status === 'open' ? 'selected' : '' %>>ğŸŸ¢ <%= t.tstatus_open %></option>
          <option value="in_progress" <%= ticket.status === 'in_progress' ? 'selected' : '' %>>ğŸ”µ <%= t.tstatus_in_progress %></option>
          <option value="waiting" <%= ticket.status === 'waiting' ? 'selected' : '' %>>ğŸŸ¡ <%= t.tstatus_waiting %></option>
          <option value="resolved" <%= ticket.status === 'resolved' ? 'selected' : '' %>>âœ… <%= t.tstatus_resolved %></option>
          <option value="closed" <%= ticket.status === 'closed' ? 'selected' : '' %>>â¬› <%= t.tstatus_closed %></option>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_priority %></label>
        <select name="priority">
          <option value="low" <%= ticket.priority === 'low' ? 'selected' : '' %>><%= t.priority_low %></option>
          <option value="medium" <%= ticket.priority === 'medium' ? 'selected' : '' %>><%= t.priority_medium %></option>
          <option value="high" <%= ticket.priority === 'high' ? 'selected' : '' %>><%= t.priority_high %></option>
          <option value="urgent" <%= ticket.priority === 'urgent' ? 'selected' : '' %>><%= t.priority_urgent %></option>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_category %></label>
        <select name="category">
          <option value="general" <%= ticket.category === 'general' ? 'selected' : '' %>><%= t.cat_general %></option>
          <option value="bug" <%= ticket.category === 'bug' ? 'selected' : '' %>><%= t.cat_bug %></option>
          <option value="question" <%= ticket.category === 'question' ? 'selected' : '' %>><%= t.cat_question %></option>
          <option value="feature_request" <%= ticket.category === 'feature_request' ? 'selected' : '' %>><%= t.cat_feature_request %></option>
          <option value="account" <%= ticket.category === 'account' ? 'selected' : '' %>><%= t.cat_account %></option>
          <option value="billing" <%= ticket.category === 'billing' ? 'selected' : '' %>><%= t.cat_billing %></option>
          <option value="other" <%= ticket.category === 'other' ? 'selected' : '' %>><%= t.cat_other %></option>
        </select>
      </div>
      <div class="sidebar-field">
        <label><%= t.label_assigned_to %></label>
        <select name="assigned_to">
          <option value=""><%= t.not_assigned %></option>
          <% agents.forEach(a => { %>
            <option value="<%= a.id %>" <%= ticket.assigned_to === a.id ? 'selected' : '' %>><%= a.full_name %></option>
          <% }) %>
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-full"><%= t.update %></button>
    </form>

    <div class="sidebar-meta">
      <div class="meta-item">
        <span class="meta-label"><%= t.label_created_by %></span>
        <span><%= ticket.creator_name %></span>
      </div>
      <div class="meta-item">
        <span class="meta-label"><%= t.label_created_at %></span>
        <span><%= new Date(ticket.created_at).toLocaleString(dateLocale) %></span>
      </div>
      <% if (ticket.resolved_at) { %>
        <div class="meta-item">
          <span class="meta-label"><%= t.label_resolved_at %></span>
          <span><%= new Date(ticket.resolved_at).toLocaleString(dateLocale) %></span>
        </div>
      <% } %>
    </div>

    <% if (!escalatedTask) { %>
      <div class="escalation-section">
        <h4><%= t.ticket_escalate_title %></h4>
        <p class="text-muted text-sm"><%= t.ticket_escalate_subtitle %></p>
        <form method="POST" action="/tickets/<%= ticket.id %>/escalate" class="escalation-form">
          <div class="form-group">
            <label><%= t.ticket_escalate_project %></label>
            <select name="project_id" required>
              <option value=""><%= t.ticket_escalate_project_placeholder %></option>
              <% projects.forEach(p => { %>
                <option value="<%= p.id %>"><%= p.code %> â€” <%= p.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label><%= t.ticket_escalate_task_title %></label>
            <input type="text" name="title" value="[Escalade] <%= ticket.subject %>" placeholder="Title...">
          </div>
          <div class="form-group">
            <label><%= t.label_priority %></label>
            <select name="priority">
              <option value="medium"><%= t.priority_label_medium %></option>
              <option value="high" <%= ticket.priority === 'high' || ticket.priority === 'urgent' ? 'selected' : '' %>><%= t.priority_label_high %></option>
              <option value="critical" <%= ticket.priority === 'urgent' ? 'selected' : '' %>><%= t.priority_label_critical %></option>
            </select>
          </div>
          <button type="submit" class="btn btn-warning btn-full"
                  onclick="return confirm('<%= t.ticket_escalate_confirm %>')">
            <%= t.ticket_escalate_btn %>
          </button>
        </form>
      </div>
    <% } %>

    <!-- FAQ Quick Access -->
    <div class="faq-quick-panel">
      <h4>ğŸ“š <%= t.ticket_faq_title %></h4>
      <div class="faq-search-mini">
        <input type="text" id="faqSearch" placeholder="<%= t.ticket_faq_search %>" autocomplete="off">
      </div>
      <div class="faq-results" id="faqResults"></div>
    </div>
  </div>
</div>

<script>
const ticketId = <%= ticket.id %>;
function sendMessage() {
  const input = document.getElementById('messageInput');
  const content = input.value.trim();
  if (!content) return;
  const isInternal = document.getElementById('isInternal').checked;
  const socket = io();
  socket.emit('ticket:message', { ticketId, content, isInternal });
  input.value = '';
}
if (typeof io !== 'undefined') {
  const socket = io();
  socket.on('ticket:newMessage', (data) => {
    if (data.ticketId === ticketId) {
      const m = data.message;
      const list = document.getElementById('messagesList');
      const emptyMsg = list.querySelector('.text-muted');
      if (emptyMsg) emptyMsg.remove();
      const div = document.createElement('div');
      div.className = 'message message-new' + (m.is_internal ? ' message-internal' : '');
      div.innerHTML = '<div class="avatar avatar-sm" style="background-color: ' + m.avatar_color + '">' + m.full_name.charAt(0) + '</div><div class="message-body"><div class="message-header"><strong>' + m.full_name + '</strong><span class="message-role">' + (m.user_role || m.role || '') + '</span>' + (m.is_internal ? '<span class="internal-badge"><%= t.ticket_internal_badge %></span>' : '') + '<time><%= t.just_now %></time></div><div class="message-content">' + m.content + '</div></div>';
      list.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }
  });
}
document.getElementById('messageInput').addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'Enter') sendMessage(); });

// â”€â”€â”€ AI Suggest Reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function aiSuggestReply() {
  const btn = document.getElementById('aiSuggestBtn');
  btn.disabled = true;
  btn.textContent = 'ğŸ¤– ...';
  try {
    const res = await fetch('/admin/articles/ai/suggest-reply', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticketId })
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('messageInput').value = data.suggestion;
      document.getElementById('messageInput').focus();
    } else {
      alert(data.error || 'AI not configured');
    }
  } catch (e) { alert('Error: ' + e.message); }
  btn.disabled = false;
  btn.textContent = 'ğŸ¤– <%= t.ticket_ai_suggest %>';
}

// â”€â”€â”€ FAQ Quick Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let faqTimeout = null;
document.getElementById('faqSearch').addEventListener('input', (e) => {
  clearTimeout(faqTimeout);
  const q = e.target.value.trim();
  if (q.length < 2) { document.getElementById('faqResults').innerHTML = ''; return; }
  faqTimeout = setTimeout(async () => {
    try {
      const res = await fetch('/help/api/search?q=' + encodeURIComponent(q));
      const articles = await res.json();
      const container = document.getElementById('faqResults');
      if (articles.length === 0) {
        container.innerHTML = '<p class="text-muted text-sm"><%= t.help_no_results %></p>';
        return;
      }
      container.innerHTML = articles.map(a =>
        '<div class="faq-result-item">' +
          '<div class="faq-result-title">' + (a.title) + (!a.is_public ? ' ğŸ”’' : '') + '</div>' +
          '<div class="faq-result-excerpt">' + (a.excerpt || '') + '</div>' +
          '<div class="faq-result-actions">' +
            '<button class="btn btn-xs btn-ghost" onclick="insertFaqLink(\'' + a.slug + '\', \'' + a.title.replace(/'/g, "\\'") + '\')"><%= t.ticket_faq_insert %></button>' +
            '<a href="/help/article/' + a.slug + '" target="_blank" class="btn btn-xs btn-ghost">ğŸ‘ï¸</a>' +
          '</div>' +
        '</div>'
      ).join('');
    } catch (e) { console.error(e); }
  }, 300);
});

function insertFaqLink(slug, title) {
  const input = document.getElementById('messageInput');
  const link = '<%= t.ticket_faq_ref_prefix %> "' + title + '": ' + window.location.origin + '/help/article/' + slug;
  input.value = input.value ? input.value + '\n\n' + link : link;
  input.focus();
}
</script>

<%- include('../partials/foot') %>
