<%- include('../partials/head') %>

<div class="content-header">
  <div>
    <h1>‚öôÔ∏è Param√®tres</h1>
    <p class="text-muted">Apparence, IA, traductions et configuration</p>
  </div>
</div>

<% if (saved) { %>
  <div class="alert alert-success" style="margin-bottom:1rem">‚úÖ Param√®tres sauvegard√©s.</div>
<% } %>

<div class="settings-grid">

  <!-- ‚ïê‚ïê‚ïê Branding & Apparence ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-header"><h2>üé® Apparence & Marque</h2></div>
    <div class="card-body">
      <p style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem">Personnalisez l'apparence de votre espace : logo, couleurs et domaine personnalis√©.</p>

      <div style="display:flex;gap:2rem;flex-wrap:wrap">
        <!-- Logo -->
        <div style="flex:1;min-width:200px">
          <label style="font-weight:600;font-size:.85rem;display:block;margin-bottom:.5rem">Logo de votre entreprise</label>
          <div id="logoPreviewArea" style="width:80px;height:80px;border-radius:12px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;margin-bottom:.5rem;transition:all .2s" onclick="document.getElementById('logoFile').click()">
            <% if (typeof tenant !== 'undefined' && tenant && tenant.logo_url) { %>
              <img src="<%= tenant.logo_url %>" style="width:100%;height:100%;object-fit:contain" id="logoPreviewImg">
            <% } else { %>
              <span style="font-size:2rem;color:var(--text-muted)" id="logoPlaceholder">üì∑</span>
              <img src="" style="width:100%;height:100%;object-fit:contain;display:none" id="logoPreviewImg">
            <% } %>
          </div>
          <input type="file" id="logoFile" accept="image/*" style="display:none" onchange="uploadLogo(this)">
          <p style="font-size:.7rem;color:var(--text-muted);margin:0">PNG ou JPG, max 512 Ko</p>
          <% if (typeof tenant !== 'undefined' && tenant && tenant.logo_url) { %>
            <button class="btn btn-sm" style="margin-top:.4rem;font-size:.75rem;padding:.2rem .5rem" onclick="removeLogo()">Supprimer le logo</button>
          <% } %>
        </div>

        <!-- Colors -->
        <div style="flex:2;min-width:250px">
          <label style="font-weight:600;font-size:.85rem;display:block;margin-bottom:.5rem">Couleur principale</label>
          <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
            <input type="color" id="brandColor" value="<%= (typeof tenant !== 'undefined' && tenant && tenant.brand_color) ? tenant.brand_color : '#6366f1' %>" style="width:50px;height:36px;border:none;border-radius:8px;cursor:pointer;padding:0">
            <input type="text" id="brandColorText" value="<%= (typeof tenant !== 'undefined' && tenant && tenant.brand_color) ? tenant.brand_color : '#6366f1' %>" style="width:100px;font-family:monospace;font-size:.8rem" onchange="document.getElementById('brandColor').value=this.value" placeholder="#6366f1">
            <div id="colorPreviewDot" style="width:32px;height:32px;border-radius:8px;background:<%= (typeof tenant !== 'undefined' && tenant && tenant.brand_color) ? tenant.brand_color : '#6366f1' %>"></div>
            <button class="btn btn-sm" style="font-size:.75rem;padding:.2rem .5rem" onclick="document.getElementById('brandColor').value='#6366f1';document.getElementById('brandColorText').value='#6366f1';document.getElementById('colorPreviewDot').style.background='#6366f1'">R√©initialiser</button>
          </div>

          <label style="font-weight:600;font-size:.85rem;display:block;margin-bottom:.5rem">Domaine personnalis√© (optionnel)</label>
          <input type="text" id="customDomain" value="<%= (typeof tenant !== 'undefined' && tenant && tenant.custom_domain) ? tenant.custom_domain : '' %>" placeholder="support.votre-domaine.com" style="width:100%;max-width:350px">
          <p style="font-size:.7rem;color:var(--text-muted);margin:.25rem 0 0">Configurez un CNAME vers <code>votre-instance.render.com</code> puis renseignez ici.</p>
        </div>
      </div>

      <button class="btn btn-primary" onclick="saveBranding()" style="margin-top:1rem" id="saveBrandingBtn">üíæ Sauvegarder l'apparence</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Translation Settings ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-header"><h2>üåê Traduction automatique des articles</h2></div>
    <div class="card-body">
      <form method="POST" action="/admin/settings">
        <div class="form-group">
          <label><strong>Langues de traduction</strong></label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0.5rem">S√©lectionnez les langues dans lesquelles les articles FAQ seront traduits automatiquement.</p>
          <div class="checkbox-grid">
            <% const langs = { en: 'üá¨üáß Anglais', es: 'üá™üá∏ Espagnol', de: 'üá©üá™ Allemand' }; %>
            <% const activeLangs = settings.translation_languages.split(','); %>
            <% for (const [code, name] of Object.entries(langs)) { %>
              <label class="checkbox-item">
                <input type="checkbox" name="translation_languages" value="<%= code %>"
                  <%= activeLangs.includes(code) ? 'checked' : '' %>>
                <span><%= name %></span>
              </label>
            <% } %>
          </div>
        </div>

        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" name="auto_translate_articles" value="1"
              <%= settings.auto_translate_articles === '1' ? 'checked' : '' %>>
            <span><strong>Traduction automatique √† la publication</strong></span>
          </label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0">Quand activ√©, les articles sont traduits automatiquement dans les langues s√©lectionn√©es lors de la publication.</p>
        </div>

        <div class="form-group" style="margin-top:1.5rem">
          <label class="toggle-label">
            <input type="checkbox" name="ai_livechat_faq_first" value="1"
              <%= settings.ai_livechat_faq_first === '1' ? 'checked' : '' %>>
            <span><strong>üîã FAQ-first (√©conomie IA)</strong></span>
          </label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0">Quand activ√©, le livechat cherche d'abord une r√©ponse dans les articles FAQ <strong>sans appeler l'IA</strong>. L'IA n'est sollicit√©e que si aucun article ne correspond.</p>
        </div>

        <hr style="margin:1.5rem 0;border-color:var(--border)">
        <h3 style="margin-bottom:0.75rem">üè¢ Identit√© de l'entreprise</h3>

        <div class="form-group">
          <label><strong>Nom de l'entreprise</strong></label>
          <input type="text" name="company_name" value="<%= settings.company_name || '' %>" placeholder="Ex: Phidias Propfirm, Acme Corp..." style="max-width:400px">
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0">Le chatbot IA se pr√©sentera comme l'assistant de cette entreprise (pas comme "Assistant ProjectHub").</p>
        </div>

        <div class="form-group">
          <label><strong>Contexte pour l'IA</strong></label>
          <textarea name="chatbot_context" rows="4" placeholder="Ex: Phidias Propfirm est une soci√©t√© de trading propri√©taire bas√©e √† Gibraltar. Nous proposons des comptes de trading √©valu√©s. Notre support est disponible en fran√ßais et anglais."><%= settings.chatbot_context || '' %></textarea>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0">Description courte de l'entreprise et de ses services. L'IA utilisera ce contexte pour r√©pondre de mani√®re plus pertinente aux visiteurs.</p>
        </div>

        <hr style="margin:1.5rem 0;border-color:var(--border)">
        <h3 style="margin-bottom:0.75rem">üî∫ Escalade vers les d√©veloppeurs</h3>

        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" name="escalation_enabled" value="1"
              <%= settings.escalation_enabled === '1' ? 'checked' : '' %>>
            <span><strong>Activer l'escalade de tickets</strong></span>
          </label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0">Permet aux agents support d'escalader des tickets vers l'√©quipe d√©veloppement en cr√©ant une t√¢che dans un projet.</p>
        </div>

        <div class="form-group" id="escalationCategoriesGroup" style="<%= settings.escalation_enabled !== '1' ? 'opacity:.5;pointer-events:none' : '' %>">
          <label><strong>Cat√©gories √©ligibles √† l'escalade</strong></label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0.5rem">Seuls les tickets de ces cat√©gories pourront √™tre escalad√©s.</p>
          <div class="checkbox-grid">
            <%
              const escCats = [
                { id: 'bug', label: 'üêõ Bug', labelEn: 'üêõ Bug' },
                { id: 'feature_request', label: 'üí° Demande de fonctionnalit√©', labelEn: 'üí° Feature Request' },
                { id: 'question', label: '‚ùì Question technique', labelEn: '‚ùì Technical Question' },
                { id: 'account', label: 'üë§ Compte', labelEn: 'üë§ Account' },
                { id: 'billing', label: 'üí≥ Facturation', labelEn: 'üí≥ Billing' },
                { id: 'general', label: 'üìã G√©n√©ral', labelEn: 'üìã General' },
                { id: 'other', label: 'üì¶ Autre', labelEn: 'üì¶ Other' }
              ];
              const activeEscCats = (settings.escalation_categories || '').split(',');
            %>
            <% escCats.forEach(cat => { %>
              <label class="checkbox-item">
                <input type="checkbox" name="escalation_categories" value="<%= cat.id %>"
                  <%= activeEscCats.includes(cat.id) ? 'checked' : '' %>>
                <span><%= cat.label %></span>
              </label>
            <% }) %>
          </div>
        </div>

        <script>
          document.querySelector('input[name="escalation_enabled"]')?.addEventListener('change', function() {
            const group = document.getElementById('escalationCategoriesGroup');
            if (this.checked) { group.style.opacity = '1'; group.style.pointerEvents = 'auto'; }
            else { group.style.opacity = '.5'; group.style.pointerEvents = 'none'; }
          });
        </script>

        <div style="margin-top:1.5rem;display:flex;gap:0.5rem;flex-wrap:wrap">
          <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
        </div>
      </form>

      <hr style="margin:1.5rem 0;border-color:var(--border)">

      <h3 style="margin-bottom:0.75rem">üìù Traduction manuelle</h3>
      <p class="text-muted" style="font-size:0.85rem;margin-bottom:0.75rem">
        <strong><%= untranslatedCount %></strong> article(s) non traduit(s) d√©tect√©(s).
      </p>
      <% if (aiConfigured) { %>
        <button class="btn btn-primary" onclick="bulkTranslate()" id="bulkTransBtn">
          <span class="btn-text">üåê Traduire tous les articles non traduits</span>
          <span class="btn-loading" style="display:none">Traduction en cours...</span>
        </button>
        <div id="translateProgress" style="display:none;margin-top:0.75rem">
          <div class="ai-progress-bar"><div class="ai-progress-fill" id="transFill" style="width:10%"></div></div>
          <p class="ai-progress-text" id="transText">Traduction en cours...</p>
        </div>
      <% } else { %>
        <p class="text-muted">‚ÑπÔ∏è <%= t.settings_ai_unavailable || 'Le service de traduction IA n\'est pas activ√© pour votre espace. Contactez-nous pour l\'activer.' %></p>
      <% } %>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê AI Profile Configuration ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-header"><h2>ü§ñ <%= t.settings_ai_profile_title || 'Profil IA de votre entreprise' %></h2></div>
    <div class="card-body">
      <p style="color:var(--text-muted);font-size:.85rem;margin-bottom:1rem"><%= t.settings_ai_profile_desc || 'Le profil IA personnalise le ton, le vocabulaire et les garde-fous de toutes les r√©ponses automatiques (livechat, suggestions tickets, FAQ).' %></p>

      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.6rem;margin-bottom:1.5rem" id="settingsProfileGrid">
        <% const profiles = ['finance','legal','saas','ecommerce','education','health','realestate','services','restaurant','generic'];
           const pIcons = {'finance':'üè¶','legal':'‚öñÔ∏è','saas':'üíª','ecommerce':'üõçÔ∏è','education':'üéì','health':'üè•','realestate':'üè†','services':'üèóÔ∏è','restaurant':'üçΩÔ∏è','generic':'üè¢'};
           const pNames = {'finance':'Finance & Banque','legal':'Juridique & Avocats','saas':'SaaS & Tech','ecommerce':'E-commerce','education':'√âducation','health':'Sant√© & M√©dical','realestate':'Immobilier','services':'Services & Conseil','restaurant':'Restauration & H√¥tel','generic':'G√©n√©raliste'};
           profiles.forEach(p => { %>
          <label class="ob-profile-card <%= (tenant && tenant.ai_profile === p) ? 'selected' : '' %>" onclick="settingsSelectProfile(this,'<%= p %>')" style="padding:.75rem .5rem;cursor:pointer;border:2px solid var(--border);border-radius:10px;text-align:center;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.2rem">
            <input type="radio" name="settings_ai_profile" value="<%= p %>" <%= (tenant && tenant.ai_profile === p) ? 'checked' : '' %> style="display:none">
            <span style="font-size:1.3rem"><%= pIcons[p] %></span>
            <span style="font-size:.75rem;font-weight:700;color:var(--text-primary)"><%= pNames[p] %></span>
          </label>
        <% }) %>
      </div>

      <div class="form-group">
        <label><%= t.settings_custom_ai_context || 'Contexte personnalis√© (optionnel)' %></label>
        <textarea id="settings_custom_ai_context" rows="4" style="width:100%;resize:vertical" placeholder="<%= t.settings_custom_ai_context_placeholder || 'D√©crivez votre activit√©, produits, r√®gles sp√©cifiques...' %>"><%= (tenant && tenant.custom_ai_context) ? tenant.custom_ai_context : '' %></textarea>
        <p style="font-size:.75rem;color:var(--text-muted);margin:.4rem 0 0"><%= t.settings_custom_ai_context_help || 'Ce texte est inject√© dans chaque r√©ponse IA, en plus du profil sectoriel. Id√©al pour vos produits, tarifs, horaires, etc.' %></p>
      </div>

      <button class="btn btn-primary" onclick="saveAiProfile()" id="saveProfileBtn">
        üíæ <%= t.save || 'Enregistrer' %>
      </button>
      <span id="profileSaveStatus" style="margin-left:.75rem;font-size:.85rem;color:var(--success);display:none">‚úÖ <%= t.saved || 'Enregistr√©' %></span>
    </div>
  </div>

  <script>
    function settingsSelectProfile(el, profileId) {
      document.querySelectorAll('#settingsProfileGrid label').forEach(c => {
        c.classList.remove('selected');
        c.style.borderColor = 'var(--border)';
        c.style.background = 'transparent';
      });
      el.classList.add('selected');
      el.style.borderColor = 'var(--accent)';
      el.style.background = 'rgba(99,102,241,.1)';
      el.querySelector('input').checked = true;
    }

    async function saveAiProfile() {
      const btn = document.getElementById('saveProfileBtn');
      const status = document.getElementById('profileSaveStatus');
      btn.disabled = true;
      btn.textContent = '<%= t.loading || "..." %>';

      const profile = document.querySelector('input[name="settings_ai_profile"]:checked');
      const ctx = document.getElementById('settings_custom_ai_context').value;

      const res = await fetch('/admin/settings/ai-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ai_profile: profile ? profile.value : 'generic',
          custom_ai_context: ctx
        })
      });

      btn.disabled = false;
      btn.innerHTML = 'üíæ <%= t.save || "Enregistrer" %>';

      if (res.ok) {
        status.style.display = 'inline';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
      }
    }
  </script>

  <!-- AI Profile config ends here -->

</div>

<script>
async function bulkTranslate() {
  const btn = document.getElementById('bulkTransBtn');
  const progress = document.getElementById('translateProgress');
  const fill = document.getElementById('transFill');
  const text = document.getElementById('transText');

  btn.querySelector('.btn-text').style.display = 'none';
  btn.querySelector('.btn-loading').style.display = 'inline';
  btn.disabled = true;
  progress.style.display = 'block';

  try {
    const res = await fetch('/admin/articles/ai/bulk-translate', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}'
    });
    const data = await res.json();

    if (data.message) {
      alert(data.message);
    } else if (data.jobId) {
      text.textContent = 'Traduction de ' + data.count + ' article(s)...';
      let polls = 0;
      const poll = async () => {
        polls++;
        fill.style.width = Math.min(10 + polls * 8, 90) + '%';
        text.textContent = 'Traduction en cours... (' + polls * 2 + 's)';
        const r = await fetch('/admin/articles/ai/job/' + data.jobId + '?t=' + Date.now());
        const job = await r.json();
        if (job.status === 'done') {
          fill.style.width = '100%';
          text.textContent = '‚úÖ ' + (job.result.translated || 0) + ' traduction(s) termin√©e(s) !';
          setTimeout(() => location.reload(), 1500);
          return;
        }
        if (job.status === 'error') { text.textContent = '‚ùå ' + job.error; return; }
        setTimeout(poll, 2000);
      };
      poll();
      return;
    }
  } catch (e) { alert('Erreur: ' + e.message); }

  btn.querySelector('.btn-text').style.display = 'inline';
  btn.querySelector('.btn-loading').style.display = 'none';
  btn.disabled = false;
}

// ‚îÄ‚îÄ‚îÄ Branding ‚îÄ‚îÄ‚îÄ
document.getElementById('brandColor')?.addEventListener('input', function() {
  document.getElementById('brandColorText').value = this.value;
  document.getElementById('colorPreviewDot').style.background = this.value;
});

async function uploadLogo(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 512 * 1024) { alert('Le fichier est trop volumineux (max 512 Ko)'); return; }
  if (!file.type.startsWith('image/')) { alert('Seules les images sont accept√©es'); return; }

  const formData = new FormData();
  formData.append('logo', file);

  try {
    const res = await fetch('/admin/settings/logo', { method: 'POST', body: formData });
    const data = await res.json();
    if (data.ok) {
      const img = document.getElementById('logoPreviewImg');
      const ph = document.getElementById('logoPlaceholder');
      img.src = data.url + '?t=' + Date.now();
      img.style.display = 'block';
      if (ph) ph.style.display = 'none';
    } else { alert('Erreur: ' + (data.error || 'Upload √©chou√©')); }
  } catch (e) { alert('Erreur: ' + e.message); }
}

async function removeLogo() {
  if (!confirm('Supprimer le logo ?')) return;
  try {
    const res = await fetch('/admin/settings/logo', { method: 'DELETE' });
    const data = await res.json();
    if (data.ok) location.reload();
  } catch (e) { alert('Erreur: ' + e.message); }
}

async function saveBranding() {
  const btn = document.getElementById('saveBrandingBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Enregistrement...';
  try {
    const res = await fetch('/admin/settings/branding', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        brand_color: document.getElementById('brandColor').value,
        custom_domain: document.getElementById('customDomain').value
      })
    });
    const data = await res.json();
    if (data.ok) { location.reload(); } else { alert('Erreur: ' + (data.error || 'Erreur')); }
  } catch (e) { alert('Erreur: ' + e.message); }
  btn.disabled = false; btn.textContent = 'üíæ Sauvegarder l\'apparence';
}
</script>

<style>
.settings-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
@media (min-width: 1024px) { .settings-grid { grid-template-columns: 1fr 1fr; } }
.checkbox-grid { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.25rem; }
.checkbox-item { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); }
.checkbox-item input:checked + span { color: var(--primary); font-weight: 600; }
.toggle-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
.toggle-label input { accent-color: var(--primary); width: 16px; height: 16px; }
.stats-mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
.stat-mini { text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); border: 1px solid var(--border); }
.stat-mini-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
.stat-mini-label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; }
.table-sm { font-size: 0.85rem; }
.table-sm th { font-weight: 600; padding: 0.5rem; border-bottom: 1px solid var(--border); }
.table-sm td { padding: 0.4rem 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
.text-success { color: #10b981; }
.alert-success { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: #10b981; padding: 0.75rem 1rem; border-radius: var(--radius); }
</style>

<%- include('../partials/foot') %>
