<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <h1 class="page-title">üè∑Ô∏è Cat√©gories d'articles</h1>
    <p class="page-subtitle"><%= categories.length %> cat√©gorie(s)</p>
  </div>
  <div class="header-btns">
    <a href="/admin/articles<%= companyId ? '?company=' + companyId : '' %>" class="btn btn-ghost">‚Üê Articles</a>
    <button class="btn btn-primary" onclick="openModal('newCatModal')">+ Nouvelle cat√©gorie</button>
  </div>
</div>

<% if (typeof companies !== 'undefined' && companies.length > 0) { %>
<div class="filters-bar" style="margin-bottom:1rem">
  <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
    <span style="font-size:.85rem;font-weight:600">üè¢ Entreprise :</span>
    <a href="/admin/articles/categories" class="btn btn-xs <%= !companyId ? 'btn-primary' : 'btn-ghost' %>">Toutes</a>
    <% companies.forEach(c => { %>
      <a href="/admin/articles/categories?company=<%= c.id %>" class="btn btn-xs <%= companyId == c.id ? 'btn-primary' : 'btn-ghost' %>"><%= c.name %></a>
    <% }) %>
  </div>
</div>
<% } %>

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th style="width:50px">Ic√¥ne</th>
        <th>Nom</th>
        <th>Nom EN</th>
        <th>Slug</th>
        <th>Entreprise</th>
        <th>Articles</th>
        <th>Position</th>
        <th><%= t.actions %></th>
      </tr>
    </thead>
    <tbody>
      <% categories.forEach(cat => { %>
        <tr>
          <td style="font-size:1.3rem;text-align:center"><%= cat.icon || 'üìÅ' %></td>
          <td><strong><%= cat.name %></strong></td>
          <td class="text-muted"><%= cat.name_en || '‚Äî' %></td>
          <td class="text-muted" style="font-size:.8rem"><%= cat.slug || '‚Äî' %></td>
          <td>
            <% if (cat.company_name) { %>
              <span class="company-tag"><%= cat.company_name %></span>
            <% } else { %>
              <span class="text-muted">Global</span>
            <% } %>
          </td>
          <td><%= cat.article_count || 0 %></td>
          <td><%= cat.position || 0 %></td>
          <td>
            <div class="action-btns">
              <button class="btn btn-xs btn-ghost" title="Modifier"
                onclick="editCat(<%= cat.id %>, '<%= (cat.name || '').replace(/'/g, "\\'") %>', '<%= (cat.name_en || '').replace(/'/g, "\\'") %>', '<%= cat.slug || '' %>', '<%= cat.icon || 'üìÅ' %>', <%= cat.position || 0 %>)">‚úèÔ∏è</button>
              <form method="POST" action="/admin/articles/categories/<%= cat.id %>/delete" style="display:inline"
                    onsubmit="return confirm('Supprimer la cat√©gorie ¬´ <%= cat.name %> ¬ª ? Les <%= cat.article_count || 0 %> article(s) associ√©(s) seront d√©cat√©goris√©s.')">
                <button type="submit" class="btn btn-xs btn-ghost" title="Supprimer">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      <% if (categories.length === 0) { %>
        <tr><td colspan="8" class="empty-table">Aucune cat√©gorie</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- New Category Modal -->
<div class="modal-overlay" id="newCatModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Nouvelle cat√©gorie</h2>
      <button class="modal-close" onclick="closeModal('newCatModal')">√ó</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="/admin/articles/categories">
        <div class="form-group">
          <label>Nom *</label>
          <input type="text" name="name" required placeholder="Ex: D√©marrage, Facturation...">
        </div>
        <div class="form-group">
          <label>Nom (EN)</label>
          <input type="text" name="name_en" placeholder="English name">
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Ic√¥ne</label>
            <input type="text" name="icon" value="üìÅ" placeholder="üìÅ" style="font-size:1.2rem">
          </div>
          <div class="form-group">
            <label>Position</label>
            <input type="number" name="position" value="" placeholder="Auto">
          </div>
        </div>
        <div class="form-group">
          <label>Slug (auto si vide)</label>
          <input type="text" name="slug" placeholder="auto-generated">
        </div>
        <% if (typeof companies !== 'undefined' && companies.length > 0) { %>
        <div class="form-group">
          <label>Entreprise</label>
          <select name="company_id">
            <option value="">‚Äî Globale ‚Äî</option>
            <% companies.forEach(c => { %>
              <option value="<%= c.id %>" <%= companyId == c.id ? 'selected' : '' %>><%= c.name %></option>
            <% }) %>
          </select>
        </div>
        <% } %>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
          <button type="button" class="btn btn-ghost" onclick="closeModal('newCatModal')">Annuler</button>
          <button type="submit" class="btn btn-primary">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal-overlay" id="editCatModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Modifier la cat√©gorie</h2>
      <button class="modal-close" onclick="closeModal('editCatModal')">√ó</button>
    </div>
    <div class="modal-body">
      <form method="POST" id="editCatForm">
        <div class="form-group">
          <label>Nom *</label>
          <input type="text" name="name" id="editName" required>
        </div>
        <div class="form-group">
          <label>Nom (EN)</label>
          <input type="text" name="name_en" id="editNameEn">
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Ic√¥ne</label>
            <input type="text" name="icon" id="editIcon" style="font-size:1.2rem">
          </div>
          <div class="form-group">
            <label>Position</label>
            <input type="number" name="position" id="editPosition">
          </div>
        </div>
        <div class="form-group">
          <label>Slug</label>
          <input type="text" name="slug" id="editSlug">
        </div>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
          <button type="button" class="btn btn-ghost" onclick="closeModal('editCatModal')">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function editCat(id, name, nameEn, slug, icon, position) {
  document.getElementById('editCatForm').action = '/admin/articles/categories/' + id + '/update';
  document.getElementById('editName').value = name;
  document.getElementById('editNameEn').value = nameEn;
  document.getElementById('editSlug').value = slug;
  document.getElementById('editIcon').value = icon;
  document.getElementById('editPosition').value = position;
  openModal('editCatModal');
}
</script>

<%- include('../partials/foot') %>
