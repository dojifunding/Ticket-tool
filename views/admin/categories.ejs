<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <h1 class="page-title">ğŸ·ï¸ Article Categories</h1>
    <p class="page-subtitle"><%= categories.length %> category(ies)</p>
  </div>
  <div class="header-btns">
    <a href="/admin/articles<%= companyId ? '?company=' + companyId : '' %>" class="btn btn-ghost">â† Articles</a>
    <button class="btn btn-primary" onclick="openModal('newCatModal')">+ New Category</button>
  </div>
</div>

<% if (typeof companies !== 'undefined' && companies.length > 0) { %>
<div class="filters-bar" style="margin-bottom:1rem">
  <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
    <span style="font-size:.85rem;font-weight:600">ğŸ¢ Company:</span>
    <a href="/admin/articles/categories" class="btn btn-xs <%= !companyId ? 'btn-primary' : 'btn-ghost' %>">All</a>
    <% companies.forEach(c => { %>
      <a href="/admin/articles/categories?company=<%= c.id %>" class="btn btn-xs <%= companyId == c.id ? 'btn-primary' : 'btn-ghost' %>"><%= c.name %></a>
    <% }) %>
  </div>
</div>
<% } %>

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th style="width:50px">Icon</th>
        <th>Name (EN) â€” Primary</th>
        <th>Translations</th>
        <th>Slug</th>
        <th>Company</th>
        <th>Articles</th>
        <th>Pos</th>
        <th><%= t.actions %></th>
      </tr>
    </thead>
    <tbody>
      <% categories.forEach(cat => { %>
        <tr>
          <td style="font-size:1.3rem;text-align:center"><%= cat.icon || 'ğŸ“' %></td>
          <td><strong><%= cat.name %></strong></td>
          <td>
            <div class="article-lang-badges" style="gap:.25rem">
              <span class="lang-badge <%= cat.name_fr ? 'lang-badge-ok' : 'lang-badge-miss' %>" title="<%= cat.name_fr || 'No FR' %>">FR</span>
              <span class="lang-badge <%= cat.name_es ? 'lang-badge-ok' : 'lang-badge-miss' %>" title="<%= cat.name_es || 'No ES' %>">ES</span>
              <span class="lang-badge <%= cat.name_de ? 'lang-badge-ok' : 'lang-badge-miss' %>" title="<%= cat.name_de || 'No DE' %>">DE</span>
            </div>
          </td>
          <td class="text-muted" style="font-size:.8rem"><%= cat.slug || 'â€”' %></td>
          <td>
            <% if (cat.company_name) { %>
              <span class="company-tag"><%= cat.company_name %></span>
            <% } else { %>
              <span class="text-muted">Global</span>
            <% } %>
          </td>
          <td><%= cat.article_count || 0 %></td>
          <td><%= cat.position || 0 %></td>
          <td>
            <div class="action-btns">
              <button class="btn btn-xs btn-ghost" title="Edit"
                onclick="editCat(<%= cat.id %>, `<%= (cat.name || '').replace(/`/g, '') %>`, `<%= (cat.name_fr || '').replace(/`/g, '') %>`, `<%= (cat.name_es || '').replace(/`/g, '') %>`, `<%= (cat.name_de || '').replace(/`/g, '') %>`, '<%= cat.slug || '' %>', '<%= cat.icon || 'ğŸ“' %>', <%= cat.position || 0 %>)">âœï¸</button>
              <form method="POST" action="/admin/articles/categories/<%= cat.id %>/delete" style="display:inline"
                    onsubmit="return confirm('Delete category &quot;<%= cat.name %>&quot;? The <%= cat.article_count || 0 %> linked article(s) will be uncategorized.')">
                <button type="submit" class="btn btn-xs btn-ghost" title="Delete">ğŸ—‘ï¸</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      <% if (categories.length === 0) { %>
        <tr><td colspan="8" class="empty-table">No categories yet</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- New Category Modal -->
<div class="modal-overlay" id="newCatModal">
  <div class="modal">
    <div class="modal-header">
      <h2>New Category</h2>
      <button class="modal-close" onclick="closeModal('newCatModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="/admin/articles/categories">
        <div class="form-group">
          <label>ğŸ‡¬ğŸ‡§ Name (English) * â€” Primary</label>
          <input type="text" name="name" required placeholder="e.g. Getting Started, Billing...">
          <p class="text-muted" style="font-size:.75rem;margin-top:.25rem">Used for the URL slug and as the default display name</p>
        </div>
        <div style="border:1px solid var(--border);border-radius:var(--radius);padding:.75rem;margin-bottom:1rem">
          <p style="font-size:.8rem;font-weight:600;margin-bottom:.5rem">ğŸŒ Translations (optional)</p>
          <div class="form-group" style="margin-bottom:.5rem">
            <label style="font-size:.85rem">ğŸ‡«ğŸ‡· French</label>
            <input type="text" name="name_fr" placeholder="Nom en franÃ§ais">
          </div>
          <div class="form-group" style="margin-bottom:.5rem">
            <label style="font-size:.85rem">ğŸ‡ªğŸ‡¸ Spanish</label>
            <input type="text" name="name_es" placeholder="Nombre en espaÃ±ol">
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label style="font-size:.85rem">ğŸ‡©ğŸ‡ª German</label>
            <input type="text" name="name_de" placeholder="Name auf Deutsch">
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Icon</label>
            <input type="text" name="icon" value="ğŸ“" placeholder="ğŸ“" style="font-size:1.2rem">
          </div>
          <div class="form-group">
            <label>Position</label>
            <input type="number" name="position" value="" placeholder="Auto">
          </div>
        </div>
        <div class="form-group">
          <label>Slug (auto if empty)</label>
          <input type="text" name="slug" placeholder="auto-generated-from-name">
        </div>
        <% if (typeof companies !== 'undefined' && companies.length > 0) { %>
        <div class="form-group">
          <label>Company</label>
          <select name="company_id">
            <option value="">â€” Global â€”</option>
            <% companies.forEach(c => { %>
              <option value="<%= c.id %>" <%= companyId == c.id ? 'selected' : '' %>><%= c.name %></option>
            <% }) %>
          </select>
        </div>
        <% } %>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
          <button type="button" class="btn btn-ghost" onclick="closeModal('newCatModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal-overlay" id="editCatModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Edit Category</h2>
      <button class="modal-close" onclick="closeModal('editCatModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <form method="POST" id="editCatForm">
        <div class="form-group">
          <label>ğŸ‡¬ğŸ‡§ Name (English) * â€” Primary</label>
          <input type="text" name="name" id="editName" required>
        </div>
        <div style="border:1px solid var(--border);border-radius:var(--radius);padding:.75rem;margin-bottom:1rem">
          <p style="font-size:.8rem;font-weight:600;margin-bottom:.5rem">ğŸŒ Translations</p>
          <div class="form-group" style="margin-bottom:.5rem">
            <label style="font-size:.85rem">ğŸ‡«ğŸ‡· French</label>
            <input type="text" name="name_fr" id="editNameFr">
          </div>
          <div class="form-group" style="margin-bottom:.5rem">
            <label style="font-size:.85rem">ğŸ‡ªğŸ‡¸ Spanish</label>
            <input type="text" name="name_es" id="editNameEs">
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label style="font-size:.85rem">ğŸ‡©ğŸ‡ª German</label>
            <input type="text" name="name_de" id="editNameDe">
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Icon</label>
            <input type="text" name="icon" id="editIcon" style="font-size:1.2rem">
          </div>
          <div class="form-group">
            <label>Position</label>
            <input type="number" name="position" id="editPosition">
          </div>
        </div>
        <div class="form-group">
          <label>Slug</label>
          <input type="text" name="slug" id="editSlug">
        </div>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
          <button type="button" class="btn btn-ghost" onclick="closeModal('editCatModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function editCat(id, name, nameFr, nameEs, nameDe, slug, icon, position) {
  document.getElementById('editCatForm').action = '/admin/articles/categories/' + id + '/update';
  document.getElementById('editName').value = name;
  document.getElementById('editNameFr').value = nameFr;
  document.getElementById('editNameEs').value = nameEs;
  document.getElementById('editNameDe').value = nameDe;
  document.getElementById('editSlug').value = slug;
  document.getElementById('editIcon').value = icon;
  document.getElementById('editPosition').value = position;
  openModal('editCatModal');
}
</script>

<%- include('../partials/foot') %>
