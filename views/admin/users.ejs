<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <a href="/admin" class="back-link"><%= t.users_back %></a>
    <h1 class="page-title"><%= t.users_title %></h1>
    <p class="page-subtitle"><%= users.length %> <%= t.users_count %></p>
  </div>
</div>

<% if (typeof query !== 'undefined' && query.error === 'duplicate') { %>
  <div class="alert alert-error"><%= t.users_error_duplicate %></div>
<% } %>

<div class="users-grid">
  <% users.forEach(u => { %>
    <div class="user-card-full <%= u.is_active ? '' : 'inactive' %>">
      <div class="user-card-header">
        <div class="avatar" style="background-color: <%= u.avatar_color %>"><%= u.full_name.charAt(0) %></div>
        <div>
          <div class="user-card-name"><%= u.full_name %></div>
          <div class="user-card-email"><%= u.email %></div>
        </div>
      </div>

      <span class="user-card-role role-<%= u.role %>">
        <%= u.role === 'admin' ? t.role_admin : u.role === 'developer' ? t.role_developer : t.role_support %>
      </span>

      <div class="user-card-stats">
        <div class="user-stat">
          <div class="user-stat-value"><%= u.active_tasks || 0 %></div>
          <div class="user-stat-label"><%= t.users_tasks %></div>
        </div>
        <div class="user-stat">
          <div class="user-stat-value"><%= u.active_tickets || 0 %></div>
          <div class="user-stat-label"><%= t.users_tickets %></div>
        </div>
        <div class="user-stat">
          <div class="user-stat-value" style="color: <%= u.is_active ? 'var(--success)' : 'var(--danger)' %>">
            <%= u.is_active ? '✓' : '✗' %>
          </div>
          <div class="user-stat-label"><%= t.users_status %></div>
        </div>
      </div>

      <div class="user-card-actions">
        <span class="text-sm text-muted" style="flex:1">@<%= u.username %></span>
        <% if (u.id !== user.id) { %>
          <form method="POST" action="/admin/users/<%= u.id %>/toggle" style="margin:0">
            <button type="submit" class="btn btn-sm <%= u.is_active ? 'btn-warning' : 'btn-primary' %>">
              <%= u.is_active ? t.users_disable : t.users_enable %>
            </button>
          </form>
        <% } else { %>
          <span class="badge badge-status-done"><%= t.you %></span>
        <% } %>
      </div>
    </div>
  <% }) %>

  <!-- New User Card -->
  <div class="new-user-card">
    <h3><%= t.users_new_title %></h3>
    <form method="POST" action="/admin/users/create">
      <div class="form-group">
        <label><%= t.users_fullname %></label>
        <input type="text" name="full_name" required placeholder="<%= t.users_fullname_placeholder %>">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label><%= t.users_username %></label>
          <input type="text" name="username" required placeholder="<%= t.users_username_placeholder %>">
        </div>
        <div class="form-group">
          <label><%= t.users_role %></label>
          <select name="role" required>
            <option value="developer"><%= t.users_role_developer %></option>
            <option value="support"><%= t.users_role_support %></option>
            <option value="admin"><%= t.users_role_admin %></option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label><%= t.users_email %></label>
        <input type="email" name="email" required placeholder="<%= t.users_email_placeholder %>">
      </div>
      <div class="form-group">
        <label><%= t.users_password %></label>
        <input type="password" name="password" required minlength="4" placeholder="••••••••">
      </div>
      <button type="submit" class="btn btn-primary btn-full"><%= t.users_create %></button>
    </form>
  </div>
</div>

<%- include('../partials/foot') %>
