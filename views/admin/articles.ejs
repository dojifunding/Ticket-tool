<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <h1 class="page-title"><%= t.articles_title %></h1>
    <p class="page-subtitle"><%= articles.length %> <%= t.articles_count %></p>
  </div>
  <div class="header-btns">
    <a href="/help" target="_blank" class="btn btn-ghost">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      <%= t.articles_view_public %>
    </a>
    <% if (aiConfigured) { %>
      <a href="/admin/articles/suggestions" class="btn btn-ghost" style="position:relative">
        ü§ñ <%= t.ai_suggestions_link %>
        <% if (typeof pendingSuggestions !== 'undefined' && pendingSuggestions > 0) { %>
          <span class="notif-dot" style="position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--danger);border-radius:50%"></span>
        <% } %>
      </a>
      <button class="btn btn-ghost" onclick="openAIModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93L12 22"/><path d="M8 6a4 4 0 0 1 8 0"/><path d="M17 12.5c1.77.83 3 2.63 3 4.72A5.22 5.22 0 0 1 14.78 22H9.22A5.22 5.22 0 0 1 4 17.22c0-2.1 1.23-3.89 3-4.72"/></svg>
        <%= t.articles_ai_generate %>
      </button>
    <% } %>
    <a href="/admin/articles/new" class="btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
      <%= t.articles_new %>
    </a>
  </div>
</div>

<% if (!aiConfigured) { %>
  <div class="alert alert-info" style="margin-bottom:1.5rem">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
    <%= t.articles_ai_not_configured %>
  </div>
<% } %>

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th><%= t.articles_col_title %></th>
        <th><%= t.articles_col_category %></th>
        <th><%= t.articles_col_visibility %></th>
        <th><%= t.articles_col_status %></th>
        <th><%= t.articles_col_views %></th>
        <th><%= t.articles_col_updated %></th>
        <th><%= t.actions %></th>
      </tr>
    </thead>
    <tbody>
      <% articles.forEach(article => { %>
        <tr>
          <td>
            <div class="article-title-cell">
              <strong><%= article.title %></strong>
              <div class="article-lang-badges">
                <span class="lang-badge lang-badge-ok">FR</span>
                <span class="lang-badge <%= article.title_en ? 'lang-badge-ok' : 'lang-badge-miss' %>">EN</span>
                <span class="lang-badge <%= article.title_es ? 'lang-badge-ok' : 'lang-badge-miss' %>">ES</span>
                <span class="lang-badge <%= article.title_de ? 'lang-badge-ok' : 'lang-badge-miss' %>">DE</span>
              </div>
            </div>
          </td>
          <td>
            <% if (article.category_name) { %>
              <span><%= article.category_icon %> <%= article.category_name %></span>
            <% } else { %>
              <span class="text-muted">‚Äî</span>
            <% } %>
          </td>
          <td>
            <span class="badge <%= article.is_public ? 'badge-status-open' : 'badge-status-closed' %>">
              <%= article.is_public ? t.articles_public : t.articles_private %>
            </span>
          </td>
          <td>
            <span class="badge <%= article.is_published ? 'badge-status-done' : 'badge-status-waiting' %>">
              <%= article.is_published ? t.articles_published : t.articles_draft %>
            </span>
          </td>
          <td><%= article.views %></td>
          <td class="text-muted"><%= new Date(article.updated_at).toLocaleDateString(dateLocale) %></td>
          <td>
            <div class="action-btns">
              <a href="/help/article/<%= article.slug %>" target="_blank" class="btn btn-xs btn-ghost" title="<%= t.articles_preview %>">üëÅÔ∏è</a>
              <a href="/admin/articles/<%= article.id %>/edit" class="btn btn-xs btn-ghost" title="<%= t.articles_edit %>">‚úèÔ∏è</a>
              <% if (aiConfigured) { %>
                <button class="btn btn-xs btn-ghost" title="Traduire" onclick="translateArticle(<%= article.id %>)" id="transBtn<%= article.id %>">üåê</button>
              <% } %>
              <form method="POST" action="/admin/articles/<%= article.id %>/toggle-publish" style="display:inline">
                <button type="submit" class="btn btn-xs btn-ghost" title="<%= article.is_published ? t.articles_unpublish : t.articles_publish %>">
                  <%= article.is_published ? 'üì§' : 'üì•' %>
                </button>
              </form>
              <form method="POST" action="/admin/articles/<%= article.id %>/delete" style="display:inline"
                    onsubmit="return confirm('<%= t.articles_delete_confirm %>')">
                <button type="submit" class="btn btn-xs btn-ghost" title="<%= t.delete_btn %>">üóëÔ∏è</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      <% if (articles.length === 0) { %>
        <tr><td colspan="7" class="empty-table"><%= t.articles_empty %></td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- AI Generate Modal -->
<% if (aiConfigured) { %>
<div class="modal-overlay" id="aiModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h2>ü§ñ <%= t.articles_ai_modal_title %></h2>
      <button class="modal-close" onclick="closeModal('aiModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="ai-tabs">
        <button class="ai-tab active" onclick="switchAiTab('fromTitle')"><%= t.articles_ai_from_title %></button>
        <button class="ai-tab" onclick="switchAiTab('fromContent')"><%= t.articles_ai_from_content %></button>
        <button class="ai-tab" onclick="switchAiTab('fromKB')"><%= t.articles_ai_from_kb %></button>
      </div>

      <div id="aiTabFromTitle" class="ai-tab-content active">
        <div class="form-group">
          <label><%= t.articles_ai_article_title %></label>
          <input type="text" id="aiTitle" placeholder="<%= t.articles_ai_title_placeholder %>">
        </div>
        <div class="form-group">
          <label><%= t.articles_ai_resources %></label>
          <textarea id="aiResources" rows="6" placeholder="<%= t.articles_ai_resources_placeholder %>"></textarea>
        </div>
        <button class="btn btn-primary" onclick="aiGenerateFromTitle()" id="aiGenBtn1">
          <span class="btn-text">ü§ñ <%= t.articles_ai_generate_btn %></span>
          <span class="btn-loading" style="display:none"><%= t.loading %></span>
        </button>
      </div>

      <div id="aiTabFromContent" class="ai-tab-content">
        <div class="form-group">
          <label><%= t.articles_ai_paste_content %></label>
          <textarea id="aiContent" rows="10" placeholder="<%= t.articles_ai_paste_placeholder %>"></textarea>
        </div>
        <button class="btn btn-primary" onclick="aiGenerateFromContent()" id="aiGenBtn2">
          <span class="btn-text">ü§ñ <%= t.articles_ai_analyze_btn %></span>
          <span class="btn-loading" style="display:none"><%= t.loading %></span>
        </button>
      </div>

      <div id="aiTabFromKB" class="ai-tab-content">
        <div class="form-group">
          <label><%= t.articles_ai_kb_label %></label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0.75rem"><%= t.articles_ai_kb_desc %></p>
          <div class="kb-select-list" id="kbList">
            <% if (typeof kbEntries !== 'undefined' && kbEntries && kbEntries.length > 0) { %>
              <label class="kb-select-all">
                <input type="checkbox" id="kbSelectAll" onchange="toggleAllKb()"> <strong><%= t.articles_ai_kb_select_all %></strong>
              </label>
              <% kbEntries.forEach(kb => { %>
                <label class="kb-select-item">
                  <input type="checkbox" name="kbIds" value="<%= kb.id %>" checked>
                  <span><%= kb.title %> <span class="text-muted">(<%= Math.round(kb.content.length / 1000) %>K)</span></span>
                </label>
              <% }) %>
            <% } else { %>
              <p class="text-muted"><%= t.articles_ai_kb_empty %></p>
            <% } %>
          </div>
        </div>
        <button class="btn btn-primary" onclick="aiGenerateFromKB()" id="aiGenBtn3">
          <span class="btn-text">ü§ñ <%= t.articles_ai_kb_generate %></span>
          <span class="btn-loading" style="display:none"><%= t.loading %></span>
        </button>
      </div>

      <!-- Progress indicator -->
      <div id="aiProgress" class="ai-progress" style="display:none">
        <div class="ai-progress-bar"><div class="ai-progress-fill" id="aiProgressFill"></div></div>
        <p class="ai-progress-text" id="aiProgressText">Analyse en cours...</p>
      </div>

      <div id="aiResult" class="ai-result" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem">
          <h3 style="margin:0"><%= t.articles_ai_result %> ‚Äî <span id="aiResultCount">0</span> articles</h3>
          <label style="font-size:0.85rem;cursor:pointer;display:flex;align-items:center;gap:0.4rem">
            <input type="checkbox" id="aiSelectAll" checked onchange="toggleAllAiArticles()"> Tout s√©lectionner
          </label>
        </div>
        <div id="aiResultContent" class="ai-result-content"></div>
        <div class="ai-result-actions">
          <button class="btn btn-primary" onclick="bulkPublish()" id="bulkPublishBtn">
            <span class="btn-text">‚úÖ Publier les articles s√©lectionn√©s</span>
            <span class="btn-loading" style="display:none"><%= t.loading %></span>
          </button>
          <button class="btn btn-ghost" onclick="aiUseSingle()">üìù Modifier le 1er dans l'√©diteur</button>
          <button class="btn btn-ghost" onclick="document.getElementById('aiResult').style.display='none'"><%= t.cancel %></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Categories data for JS -->
<script>
const CATEGORIES = <%- JSON.stringify((categories || []).map(c => ({ id: c.id, name: c.name, slug: c.slug }))) %>;
</script>
<% } %>

<script>
function openAIModal() { document.getElementById('aiModal').classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function switchAiTab(tab) {
  document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.ai-tab-content').forEach(t => t.classList.remove('active'));
  const tabs = document.querySelectorAll('.ai-tab');
  if (tab === 'fromTitle') { tabs[0].classList.add('active'); document.getElementById('aiTabFromTitle').classList.add('active'); }
  else if (tab === 'fromContent') { tabs[1].classList.add('active'); document.getElementById('aiTabFromContent').classList.add('active'); }
  else { tabs[2].classList.add('active'); document.getElementById('aiTabFromKB').classList.add('active'); }
}

let aiGeneratedData = null;

// ‚îÄ‚îÄ‚îÄ Async Job Polling ‚îÄ‚îÄ‚îÄ
function pollJob(jobId, interval = 2000, maxTime = 180000) {
  const progress = document.getElementById('aiProgress');
  const progressFill = document.getElementById('aiProgressFill');
  const progressText = document.getElementById('aiProgressText');
  let pollCount = 0;

  const messages = [
    'Analyse du contenu de la base de connaissances...',
    'D√©coupage en sections th√©matiques...',
    'G√©n√©ration des articles FAQ (lot 1)...',
    'G√©n√©ration des articles FAQ (lot 2)...',
    'G√©n√©ration des articles FAQ (lot 3)...',
    'G√©n√©ration des articles FAQ (lot 4)...',
    'G√©n√©ration des articles FAQ (lot 5)...',
    'G√©n√©ration des articles FAQ (lot 6)...',
    'G√©n√©ration en cours...',
    'Classification des articles...',
    'Presque termin√©...',
    'Finalisation...'
  ];

  if (progress) { progress.style.display = 'block'; progressFill.style.width = '5%'; }

  return new Promise((resolve, reject) => {
    const start = Date.now();
    const check = async () => {
      try {
        pollCount++;
        // Update progress UI
        if (progressText) progressText.textContent = messages[Math.min(pollCount - 1, messages.length - 1)];
        if (progressFill) progressFill.style.width = Math.min(5 + pollCount * 6, 90) + '%';

        const res = await fetch('/admin/articles/ai/job/' + jobId);
        const job = await res.json();
        if (job.status === 'done') {
          if (progressFill) progressFill.style.width = '100%';
          if (progressText) progressText.textContent = '‚úÖ Termin√© !';
          setTimeout(() => { if (progress) progress.style.display = 'none'; }, 800);
          return resolve(job.result);
        }
        if (job.status === 'error') { if (progress) progress.style.display = 'none'; return reject(new Error(job.error || 'Erreur IA')); }
        if (job.status === 'not_found') { if (progress) progress.style.display = 'none'; return reject(new Error('Job introuvable')); }
        if (Date.now() - start > maxTime) { if (progress) progress.style.display = 'none'; return reject(new Error('Timeout')); }
        setTimeout(check, interval);
      } catch (e) { if (progress) progress.style.display = 'none'; reject(e); }
    };
    check();
  });
}

function setBtn(btn, loading) {
  btn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
  btn.querySelector('.btn-loading').style.display = loading ? 'inline' : 'none';
  btn.disabled = loading;
}

// ‚îÄ‚îÄ‚îÄ Build category <select> HTML ‚îÄ‚îÄ‚îÄ
function catSelect(suggested, idx) {
  let html = '<select class="ai-cat-select" data-idx="' + idx + '">';
  html += '<option value="">‚Äî Sans cat√©gorie ‚Äî</option>';
  CATEGORIES.forEach(c => {
    const sel = (suggested && (c.slug === suggested || c.name.toLowerCase() === (suggested||'').toLowerCase())) ? ' selected' : '';
    html += '<option value="' + c.id + '"' + sel + '>' + c.name + '</option>';
  });
  html += '</select>';
  return html;
}

// ‚îÄ‚îÄ‚îÄ Show All Generated Articles ‚îÄ‚îÄ‚îÄ
function showArticles(articles) {
  aiGeneratedData = articles;
  document.getElementById('aiResultCount').textContent = articles.length;

  let html = '';
  articles.forEach((a, i) => {
    html += '<div class="ai-article-card">';
    html += '<div class="ai-article-header">';
    html += '<label class="ai-article-check"><input type="checkbox" checked data-idx="' + i + '" class="ai-publish-cb"></label>';
    html += '<div class="ai-article-info">';
    html += '<input type="text" class="ai-article-title-input" data-idx="' + i + '" value="' + (a.title || '').replace(/"/g, '&quot;') + '">';
    html += '<div class="ai-article-meta">' + catSelect(a.category_suggestion, i);
    html += '<span class="text-muted" style="font-size:0.8rem">' + ((a.content||'').length) + ' chars</span></div>';
    html += '</div></div>';
    if (a.excerpt) html += '<p class="ai-article-excerpt">' + a.excerpt + '</p>';
    html += '<details><summary style="font-size:0.85rem;color:var(--primary);cursor:pointer">Aper√ßu du contenu</summary>';
    html += '<pre class="ai-article-preview">' + (a.content||'').substring(0, 500) + (a.content && a.content.length > 500 ? '...' : '') + '</pre>';
    html += '</details></div>';
  });

  document.getElementById('aiResultContent').innerHTML = html;
  document.getElementById('aiResult').style.display = 'block';
}

function toggleAllAiArticles() {
  const checked = document.getElementById('aiSelectAll').checked;
  document.querySelectorAll('.ai-publish-cb').forEach(cb => cb.checked = checked);
}

// ‚îÄ‚îÄ‚îÄ Bulk Publish ‚îÄ‚îÄ‚îÄ
async function bulkPublish() {
  if (!aiGeneratedData) return;
  const btn = document.getElementById('bulkPublishBtn');
  setBtn(btn, true);

  const articles = [];
  document.querySelectorAll('.ai-publish-cb').forEach(cb => {
    const idx = parseInt(cb.dataset.idx);
    const a = aiGeneratedData[idx];
    if (!a) return;
    const titleInput = document.querySelector('.ai-article-title-input[data-idx="' + idx + '"]');
    const catSelect = document.querySelector('.ai-cat-select[data-idx="' + idx + '"]');
    articles.push({
      publish: cb.checked,
      title: titleInput ? titleInput.value : a.title,
      content: a.content,
      excerpt: a.excerpt || '',
      category_id: catSelect ? (catSelect.value || null) : null
    });
  });

  const selected = articles.filter(a => a.publish);
  if (!selected.length) { alert('S√©lectionnez au moins un article.'); setBtn(btn, false); return; }

  try {
    const res = await fetch('/admin/articles/ai/bulk-publish', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ articles })
    });
    const data = await res.json();
    if (data.ok) {
      alert('‚úÖ ' + data.published + ' article(s) publi√©(s) !');
      location.reload();
    } else { alert('Erreur: ' + (data.error || 'Inconnue')); }
  } catch (e) { alert('Erreur: ' + e.message); }

  setBtn(btn, false);
}

// ‚îÄ‚îÄ‚îÄ Use single article in editor ‚îÄ‚îÄ‚îÄ
function aiUseSingle() {
  if (!aiGeneratedData || !aiGeneratedData[0]) return;
  const a = aiGeneratedData[0];
  sessionStorage.setItem('ai_article', JSON.stringify(a));
  window.location.href = '/admin/articles/new';
}

// ‚îÄ‚îÄ‚îÄ AI Generation Functions ‚îÄ‚îÄ‚îÄ
async function aiGenerateFromTitle() {
  const title = document.getElementById('aiTitle').value.trim();
  if (!title) return;
  const btn = document.getElementById('aiGenBtn1');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/generate', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, resources: document.getElementById('aiResources').value.trim() })
    });
    const data = await res.json();
    if (!data.ok || !data.jobId) throw new Error(data.error || 'Erreur');
    const result = await pollJob(data.jobId);
    showArticles(result.articles || []);
  } catch (e) { alert('‚ùå ' + e.message); }
  setBtn(btn, false);
}

async function aiGenerateFromContent() {
  const content = document.getElementById('aiContent').value.trim();
  if (!content) return;
  const btn = document.getElementById('aiGenBtn2');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/generate-from-content', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });
    const data = await res.json();
    if (!data.ok || !data.jobId) throw new Error(data.error || 'Erreur');
    const result = await pollJob(data.jobId);
    showArticles(result.articles || []);
  } catch (e) { alert('‚ùå ' + e.message); }
  setBtn(btn, false);
}

async function aiGenerateFromKB() {
  const checks = document.querySelectorAll('input[name="kbIds"]:checked');
  if (!checks.length) return alert('S√©lectionnez au moins une entr√©e de la base de connaissances.');
  const kbIds = Array.from(checks).map(cb => parseInt(cb.value));
  const btn = document.getElementById('aiGenBtn3');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/generate-from-kb', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ kbIds })
    });
    const data = await res.json();
    if (!data.ok || !data.jobId) throw new Error(data.error || 'Erreur');
    const result = await pollJob(data.jobId);
    showArticles(result.articles || []);
  } catch (e) { alert('‚ùå ' + e.message); }
  setBtn(btn, false);
}

// On modal overlay click
document.getElementById('aiModal')?.addEventListener('click', function(e) { if (e.target === this) closeModal('aiModal'); });

function toggleAllKb() {
  const checked = document.getElementById('kbSelectAll').checked;
  document.querySelectorAll('input[name="kbIds"]').forEach(cb => cb.checked = checked);
}

// ‚îÄ‚îÄ‚îÄ Translate single article ‚îÄ‚îÄ‚îÄ
async function translateArticle(id) {
  const btn = document.getElementById('transBtn' + id);
  if (!btn) return;
  btn.textContent = '‚è≥';
  btn.disabled = true;
  try {
    const res = await fetch('/admin/articles/' + id + '/translate', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}'
    });
    const data = await res.json();
    if (data.jobId) {
      // Poll for completion
      const poll = async () => {
        const r = await fetch('/admin/articles/ai/job/' + data.jobId);
        const job = await r.json();
        if (job.status === 'done') { btn.textContent = '‚úÖ'; setTimeout(() => location.reload(), 800); return; }
        if (job.status === 'error') { btn.textContent = '‚ùå'; alert('Erreur: ' + job.error); return; }
        setTimeout(poll, 2000);
      };
      poll();
    } else {
      btn.textContent = '‚úÖ';
      alert(data.message || 'Traduit !');
    }
  } catch (e) { btn.textContent = '‚ùå'; alert('Erreur: ' + e.message); }
}
</script>

<%- include('../partials/foot') %>
