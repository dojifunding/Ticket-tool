<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <h1 class="page-title"><%= (typeof selectedCompany !== 'undefined' && selectedCompany) ? selectedCompany.name + ' â€” ' : '' %><%= t.articles_title %></h1>
    <p class="page-subtitle"><%= articles.length %> <%= t.articles_count %></p>
  </div>
  <div class="header-btns">
    <% if (typeof selectedCompany !== 'undefined' && selectedCompany) { %>
      <a href="/help/c/<%= selectedCompany.slug %>" target="_blank" class="btn btn-ghost">ğŸŒ Help Center</a>
      <a href="/admin/companies/<%= selectedCompany.id %>/workspace" class="btn btn-ghost">âš™ï¸ Workspace</a>
    <% } else { %>
      <a href="/help" target="_blank" class="btn btn-ghost">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        <%= t.articles_view_public %>
      </a>
    <% } %>
    <% if (aiConfigured) { %>
      <a href="/admin/articles/suggestions<%= (typeof companyId !== 'undefined' && companyId) ? '?company=' + companyId : '' %>" class="btn btn-ghost" style="position:relative">
        ğŸ¤– <%= t.ai_suggestions_link %>
        <% if (typeof pendingSuggestions !== 'undefined' && pendingSuggestions > 0) { %>
          <span class="notif-dot" style="position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--danger);border-radius:50%"></span>
        <% } %>
      </a>
      <button class="btn btn-ghost" onclick="openAIModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93L12 22"/><path d="M8 6a4 4 0 0 1 8 0"/><path d="M17 12.5c1.77.83 3 2.63 3 4.72A5.22 5.22 0 0 1 14.78 22H9.22A5.22 5.22 0 0 1 4 17.22c0-2.1 1.23-3.89 3-4.72"/></svg>
        <%= t.articles_ai_generate %>
      </button>
    <% } %>
    <a href="/admin/articles/categories<%= (typeof companyId !== 'undefined' && companyId) ? '?company=' + companyId : '' %>" class="btn btn-ghost">ğŸ·ï¸ CatÃ©gories</a>
    <a href="/admin/articles/new<%= (typeof companyId !== 'undefined' && companyId) ? '?company=' + companyId : '' %>" class="btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
      <%= t.articles_new %>
    </a>
  </div>
</div>

<% if (typeof companies !== 'undefined' && companies.length > 0) { %>
<div class="filters-bar" style="margin-bottom:1rem">
  <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
    <span style="font-size:.85rem;font-weight:600">ğŸ¢ Entreprise :</span>
    <a href="/admin/articles" class="btn btn-xs <%= !companyId ? 'btn-primary' : 'btn-ghost' %>">Toutes</a>
    <% companies.forEach(c => { %>
      <a href="/admin/articles?company=<%= c.id %>" class="btn btn-xs <%= companyId == c.id ? 'btn-primary' : 'btn-ghost' %>"><%= c.name %></a>
    <% }) %>
  </div>
</div>
<% } %>

<% if (!aiConfigured) { %>
  <div class="alert alert-info" style="margin-bottom:1.5rem">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
    <%= t.articles_ai_not_configured %>
  </div>
<% } %>

<!-- Bulk Action Bar -->
<div id="bulkBar" style="display:none;margin-bottom:1rem;padding:.75rem 1rem;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);align-items:center;gap:1rem;flex-wrap:wrap">
  <span id="bulkCount" style="font-weight:600;font-size:.85rem">0 sÃ©lectionnÃ©(s)</span>
  <select id="bulkCategory" style="padding:.35rem .5rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:.85rem">
    <option value="">â€” Changer la catÃ©gorie â€”</option>
    <% categories.forEach(cat => { %>
      <option value="<%= cat.id %>"><%= cat.icon %> <%= cat.name %></option>
    <% }) %>
  </select>
  <button class="btn btn-xs btn-primary" onclick="applyBulkCategory()">Appliquer</button>
  <button class="btn btn-xs btn-ghost" onclick="clearSelection()" style="margin-left:auto">âœ• Annuler</button>
</div>

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th style="width:30px"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
        <th><%= t.articles_col_title %></th>
        <th><%= t.articles_col_category %></th>
        <th><%= t.articles_col_visibility %></th>
        <th><%= t.articles_col_status %></th>
        <th><%= t.articles_col_views %></th>
        <th><%= t.articles_col_updated %></th>
        <th><%= t.actions %></th>
      </tr>
    </thead>
    <tbody>
      <% articles.forEach(article => { %>
        <tr>
          <td><input type="checkbox" class="article-check" value="<%= article.id %>" onchange="updateBulkBar()"></td>
          <td>
            <div class="article-title-cell">
              <strong><%= article.title %></strong>
              <div class="article-lang-badges">
                <span class="lang-badge lang-badge-ok">FR</span>
                <span class="lang-badge <%= article.title_en ? 'lang-badge-ok' : 'lang-badge-miss' %>">EN</span>
                <span class="lang-badge <%= article.title_es ? 'lang-badge-ok' : 'lang-badge-miss' %>">ES</span>
                <span class="lang-badge <%= article.title_de ? 'lang-badge-ok' : 'lang-badge-miss' %>">DE</span>
              </div>
            </div>
          </td>
          <td>
            <% if (article.category_name) { %>
              <span><%= article.category_icon %> <%= article.category_name %></span>
            <% } else { %>
              <span class="text-muted">â€”</span>
            <% } %>
            <% if (typeof article.company_name !== 'undefined' && article.company_name && !companyId) { %>
              <div class="company-tag" style="margin-top:.2rem"><%= article.company_name %></div>
            <% } %>
          </td>
          <td>
            <span class="badge <%= article.is_public ? 'badge-status-open' : 'badge-status-closed' %>">
              <%= article.is_public ? t.articles_public : t.articles_private %>
            </span>
          </td>
          <td>
            <span class="badge <%= article.is_published ? 'badge-status-done' : 'badge-status-waiting' %>">
              <%= article.is_published ? t.articles_published : t.articles_draft %>
            </span>
          </td>
          <td><%= article.views %></td>
          <td class="text-muted"><%= new Date(article.updated_at).toLocaleDateString(dateLocale) %></td>
          <td>
            <div class="action-btns">
              <a href="<%= article.company_slug ? '/help/c/' + article.company_slug + '/article/' + article.slug : '/help/article/' + article.slug %>" target="_blank" class="btn btn-xs btn-ghost" title="<%= t.articles_preview %>">ğŸ‘ï¸</a>
              <a href="/admin/articles/<%= article.id %>/edit" class="btn btn-xs btn-ghost" title="<%= t.articles_edit %>">âœï¸</a>
              <% if (aiConfigured) { %>
                <button class="btn btn-xs btn-ghost" title="Traduire" onclick="translateArticle(<%= article.id %>)" id="transBtn<%= article.id %>">ğŸŒ</button>
              <% } %>
              <form method="POST" action="/admin/articles/<%= article.id %>/toggle-publish" style="display:inline">
                <button type="submit" class="btn btn-xs btn-ghost" title="<%= article.is_published ? t.articles_unpublish : t.articles_publish %>">
                  <%= article.is_published ? 'ğŸ“¤' : 'ğŸ“¥' %>
                </button>
              </form>
              <form method="POST" action="/admin/articles/<%= article.id %>/delete" style="display:inline"
                    onsubmit="return confirm('<%= t.articles_delete_confirm %>')">
                <button type="submit" class="btn btn-xs btn-ghost" title="<%= t.delete_btn %>">ğŸ—‘ï¸</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      <% if (articles.length === 0) { %>
        <tr><td colspan="8" class="empty-table"><%= t.articles_empty %></td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- AI Generate Modal -->
<% if (aiConfigured) { %>
<div class="modal-overlay" id="aiModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h2>ğŸ¤– <%= t.articles_ai_modal_title %></h2>
      <button class="modal-close" onclick="closeModal('aiModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="ai-tabs">
        <button class="ai-tab active" onclick="switchAiTab('fromTitle')"><%= t.articles_ai_from_title %></button>
        <button class="ai-tab" onclick="switchAiTab('fromContent')"><%= t.articles_ai_from_content %></button>
        <button class="ai-tab" onclick="switchAiTab('fromKB')"><%= t.articles_ai_from_kb %></button>
      </div>

      <div id="aiTabFromTitle" class="ai-tab-content active">
        <div class="form-group">
          <label><%= t.articles_ai_article_title %></label>
          <input type="text" id="aiTitle" placeholder="<%= t.articles_ai_title_placeholder %>">
        </div>
        <div class="form-group">
          <label><%= t.articles_ai_resources %></label>
          <textarea id="aiResources" rows="6" placeholder="<%= t.articles_ai_resources_placeholder %>"></textarea>
        </div>
        <button class="btn btn-primary" onclick="aiGenerateFromTitle()" id="aiGenBtn1">
          <span class="btn-text">ğŸ¤– <%= t.articles_ai_generate_btn %></span>
          <span class="btn-loading" style="display:none"><%= t.loading %></span>
        </button>
      </div>

      <div id="aiTabFromContent" class="ai-tab-content">
        <div class="form-group">
          <label><%= t.articles_ai_paste_content %></label>
          <textarea id="aiContent" rows="10" placeholder="<%= t.articles_ai_paste_placeholder %>"></textarea>
        </div>
        <button class="btn btn-primary" onclick="aiGenerateFromContent()" id="aiGenBtn2">
          <span class="btn-text">ğŸ¤– <%= t.articles_ai_analyze_btn %></span>
          <span class="btn-loading" style="display:none"><%= t.loading %></span>
        </button>
      </div>

      <div id="aiTabFromKB" class="ai-tab-content">
        <div class="form-group">
          <label><%= t.articles_ai_kb_label %></label>
          <p class="text-muted" style="font-size:0.85rem;margin:0.25rem 0 0.75rem"><%= t.articles_ai_kb_desc %></p>
          <div class="kb-select-list" id="kbList">
            <% if (typeof kbEntries !== 'undefined' && kbEntries && kbEntries.length > 0) { %>
              <label class="kb-select-all">
                <input type="checkbox" id="kbSelectAll" onchange="toggleAllKb()"> <strong><%= t.articles_ai_kb_select_all %></strong>
              </label>
              <% kbEntries.forEach(kb => { %>
                <label class="kb-select-item">
                  <input type="checkbox" name="kbIds" value="<%= kb.id %>" checked>
                  <span><%= kb.title %> <span class="text-muted">(<%= Math.round(kb.content.length / 1000) %>K)</span></span>
                </label>
              <% }) %>
            <% } else { %>
              <p class="text-muted"><%= t.articles_ai_kb_empty %></p>
            <% } %>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;flex-wrap:wrap">
          <label style="font-size:0.85rem;color:var(--text-secondary)">ğŸŒ Langue des articles :</label>
          <select id="kbOutputLang" style="padding:0.35rem 0.6rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg-secondary);color:var(--text);font-size:0.85rem">
            <option value="source" selected>ğŸ“„ Conserver la langue d'origine</option>
            <option value="fr">ğŸ‡«ğŸ‡· Traduire en FranÃ§ais</option>
            <option value="en">ğŸ‡¬ğŸ‡§ Traduire en Anglais</option>
            <option value="es">ğŸ‡ªğŸ‡¸ Traduire en Espagnol</option>
            <option value="de">ğŸ‡©ğŸ‡ª Traduire en Allemand</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="aiGenerateFromKB()" id="aiGenBtn3">
          <span class="btn-text">ğŸ¤– <%= t.articles_ai_kb_generate %></span>
          <span class="btn-loading" style="display:none"><%= t.loading %></span>
        </button>
        <button class="btn btn-ghost" onclick="diagKB()" id="diagBtn" style="margin-left:0.5rem">
          <span class="btn-text">ğŸ” Diagnostic</span>
          <span class="btn-loading" style="display:none">Analyse...</span>
        </button>
        <div id="diagResult" style="display:none;margin-top:0.75rem;padding:0.75rem;background:var(--bg-tertiary);border-radius:var(--radius);font-size:0.85rem;max-height:350px;overflow-y:auto"></div>
      </div>

      <!-- Progress indicator -->
      <div id="aiProgress" class="ai-progress" style="display:none">
        <div class="ai-progress-bar"><div class="ai-progress-fill" id="aiProgressFill"></div></div>
        <p class="ai-progress-text" id="aiProgressText">Analyse en cours...</p>
      </div>

      <div id="aiResult" class="ai-result" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem">
          <h3 style="margin:0"><%= t.articles_ai_result %> â€” <span id="aiResultCount">0</span> articles</h3>
          <label style="font-size:0.85rem;cursor:pointer;display:flex;align-items:center;gap:0.4rem">
            <input type="checkbox" id="aiSelectAll" checked onchange="toggleAllAiArticles()"> Tout sÃ©lectionner
          </label>
        </div>
        <div id="aiResultContent" class="ai-result-content"></div>
        <div class="ai-result-actions">
          <button class="btn btn-primary" onclick="bulkPublish()" id="bulkPublishBtn">
            <span class="btn-text">âœ… Publier les articles sÃ©lectionnÃ©s</span>
            <span class="btn-loading" style="display:none"><%= t.loading %></span>
          </button>
          <button class="btn btn-ghost" onclick="aiUseSingle()">ğŸ“ Modifier le 1er dans l'Ã©diteur</button>
          <button class="btn btn-ghost" onclick="document.getElementById('aiResult').style.display='none'"><%= t.cancel %></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Categories data for JS -->
<script>
const CATEGORIES = <%- JSON.stringify((categories || []).map(c => ({ id: c.id, name: c.name, slug: c.slug }))) %>;
</script>
<% } %>

<script>
const currentCompanyId = '<%= typeof companyId !== "undefined" && companyId ? companyId : "" %>';
function openAIModal() { document.getElementById('aiModal').classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function switchAiTab(tab) {
  document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.ai-tab-content').forEach(t => t.classList.remove('active'));
  const tabs = document.querySelectorAll('.ai-tab');
  if (tab === 'fromTitle') { tabs[0].classList.add('active'); document.getElementById('aiTabFromTitle').classList.add('active'); }
  else if (tab === 'fromContent') { tabs[1].classList.add('active'); document.getElementById('aiTabFromContent').classList.add('active'); }
  else { tabs[2].classList.add('active'); document.getElementById('aiTabFromKB').classList.add('active'); }
}

let aiGeneratedData = null;

// â”€â”€â”€ Async Job Polling â”€â”€â”€
function pollJob(jobId, interval = 2000, maxTime = 300000) {
  const progress = document.getElementById('aiProgress');
  const progressFill = document.getElementById('aiProgressFill');
  const progressText = document.getElementById('aiProgressText');
  let pollCount = 0;
  let notFoundRetries = 0;
  const maxNotFoundRetries = 5; // retry up to 5 times on not_found

  const messages = [
    'Analyse du contenu de la base de connaissances...',
    'DÃ©coupage en sections thÃ©matiques...',
    'GÃ©nÃ©ration des articles FAQ (lot 1)...',
    'GÃ©nÃ©ration des articles FAQ (lot 2)...',
    'GÃ©nÃ©ration des articles FAQ (lot 3)...',
    'GÃ©nÃ©ration des articles FAQ (lot 4)...',
    'GÃ©nÃ©ration des articles FAQ (lot 5)...',
    'GÃ©nÃ©ration des articles FAQ (lot 6)...',
    'GÃ©nÃ©ration des articles FAQ (lot 7)...',
    'Encore quelques lots en cours...',
    'Classification des articles...',
    'Presque terminÃ©, patience...',
    'Finalisation en cours...',
    'DerniÃ¨res vÃ©rifications...',
    'Ã‡a arrive bientÃ´t...'
  ];

  if (progress) { progress.style.display = 'block'; progressFill.style.width = '5%'; }

  return new Promise((resolve, reject) => {
    const start = Date.now();
    const check = async () => {
      try {
        pollCount++;
        // Update progress UI
        if (progressText) progressText.textContent = messages[Math.min(pollCount - 1, messages.length - 1)];
        if (progressFill) progressFill.style.width = Math.min(5 + pollCount * 4, 90) + '%';

        const res = await fetch('/admin/articles/ai/job/' + jobId + '?t=' + Date.now());
        const job = await res.json();
        if (job.status === 'done') {
          if (progressFill) progressFill.style.width = '100%';
          if (progressText) progressText.textContent = 'âœ… TerminÃ© !';
          setTimeout(() => { if (progress) progress.style.display = 'none'; }, 800);
          return resolve(job.result);
        }
        if (job.status === 'error') { if (progress) progress.style.display = 'none'; return reject(new Error(job.error || 'Erreur IA')); }
        if (job.status === 'not_found') {
          notFoundRetries++;
          if (notFoundRetries >= maxNotFoundRetries) {
            if (progress) progress.style.display = 'none';
            return reject(new Error('Job introuvable aprÃ¨s ' + maxNotFoundRetries + ' tentatives. VÃ©rifiez la console serveur.'));
          }
          // Retry â€” job may not be registered yet
          setTimeout(check, interval);
          return;
        }
        if (Date.now() - start > maxTime) { if (progress) progress.style.display = 'none'; return reject(new Error('Timeout')); }
        setTimeout(check, interval);
      } catch (e) { if (progress) progress.style.display = 'none'; reject(e); }
    };
    check();
  });
}

function setBtn(btn, loading) {
  btn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
  btn.querySelector('.btn-loading').style.display = loading ? 'inline' : 'none';
  btn.disabled = loading;
}

// â”€â”€â”€ Build category <select> HTML â”€â”€â”€
function catSelect(suggested, idx) {
  let html = '<select class="ai-cat-select" data-idx="' + idx + '">';
  html += '<option value="">â€” Sans catÃ©gorie â€”</option>';
  CATEGORIES.forEach(c => {
    const sel = (suggested && (c.slug === suggested || c.name.toLowerCase() === (suggested||'').toLowerCase())) ? ' selected' : '';
    html += '<option value="' + c.id + '"' + sel + '>' + c.name + '</option>';
  });
  html += '</select>';
  return html;
}

// â”€â”€â”€ Show All Generated Articles â”€â”€â”€
function showArticles(articles) {
  aiGeneratedData = articles;
  document.getElementById('aiResultCount').textContent = articles.length;

  let html = '';
  articles.forEach((a, i) => {
    html += '<div class="ai-article-card">';
    html += '<div class="ai-article-header">';
    html += '<label class="ai-article-check"><input type="checkbox" checked data-idx="' + i + '" class="ai-publish-cb"></label>';
    html += '<div class="ai-article-info">';
    html += '<input type="text" class="ai-article-title-input" data-idx="' + i + '" value="' + (a.title || '').replace(/"/g, '&quot;') + '">';
    html += '<div class="ai-article-meta">' + catSelect(a.category_suggestion, i);
    html += '<span class="text-muted" style="font-size:0.8rem">' + ((a.content||'').length) + ' chars</span></div>';
    html += '</div></div>';
    if (a.excerpt) html += '<p class="ai-article-excerpt">' + a.excerpt + '</p>';
    html += '<details><summary style="font-size:0.85rem;color:var(--primary);cursor:pointer">AperÃ§u du contenu</summary>';
    html += '<pre class="ai-article-preview">' + (a.content||'').substring(0, 500) + (a.content && a.content.length > 500 ? '...' : '') + '</pre>';
    html += '</details></div>';
  });

  document.getElementById('aiResultContent').innerHTML = html;
  document.getElementById('aiResult').style.display = 'block';
}

function toggleAllAiArticles() {
  const checked = document.getElementById('aiSelectAll').checked;
  document.querySelectorAll('.ai-publish-cb').forEach(cb => cb.checked = checked);
}

// â”€â”€â”€ Bulk Publish â”€â”€â”€
async function bulkPublish() {
  if (!aiGeneratedData) return;
  const btn = document.getElementById('bulkPublishBtn');
  setBtn(btn, true);

  const articles = [];
  document.querySelectorAll('.ai-publish-cb').forEach(cb => {
    const idx = parseInt(cb.dataset.idx);
    const a = aiGeneratedData[idx];
    if (!a) return;
    const titleInput = document.querySelector('.ai-article-title-input[data-idx="' + idx + '"]');
    const catSelect = document.querySelector('.ai-cat-select[data-idx="' + idx + '"]');
    articles.push({
      publish: cb.checked,
      title: titleInput ? titleInput.value : a.title,
      content: a.content,
      excerpt: a.excerpt || '',
      category_id: catSelect ? (catSelect.value || null) : null
    });
  });

  const selected = articles.filter(a => a.publish);
  if (!selected.length) { alert('SÃ©lectionnez au moins un article.'); setBtn(btn, false); return; }

  try {
    const res = await fetch('/admin/articles/ai/bulk-publish', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ articles, company_id: currentCompanyId })
    });
    const data = await res.json();
    if (data.ok) {
      alert('âœ… ' + data.published + ' article(s) publiÃ©(s) !');
      location.reload();
    } else { alert('Erreur: ' + (data.error || 'Inconnue')); }
  } catch (e) { alert('Erreur: ' + e.message); }

  setBtn(btn, false);
}

// â”€â”€â”€ Use single article in editor â”€â”€â”€
function aiUseSingle() {
  if (!aiGeneratedData || !aiGeneratedData[0]) return;
  const a = aiGeneratedData[0];
  sessionStorage.setItem('ai_article', JSON.stringify(a));
  window.location.href = '/admin/articles/new';
}

// â”€â”€â”€ AI Generation Functions â”€â”€â”€
async function aiGenerateFromTitle() {
  const title = document.getElementById('aiTitle').value.trim();
  if (!title) return;
  const btn = document.getElementById('aiGenBtn1');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/generate', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, resources: document.getElementById('aiResources').value.trim(), company_id: currentCompanyId })
    });
    const data = await res.json();
    if (!data.ok || !data.jobId) throw new Error(data.error || 'Erreur');
    const result = await pollJob(data.jobId);
    showArticles(result.articles || []);
  } catch (e) { alert('âŒ ' + e.message); }
  setBtn(btn, false);
}

async function aiGenerateFromContent() {
  const content = document.getElementById('aiContent').value.trim();
  if (!content) return;
  const outputLang = document.getElementById('kbOutputLang')?.value || 'source';
  const btn = document.getElementById('aiGenBtn2');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/generate-from-content', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, company_id: currentCompanyId, output_lang: outputLang })
    });
    const data = await res.json();
    if (!data.ok || !data.jobId) throw new Error(data.error || 'Erreur');
    const result = await pollJob(data.jobId);
    showArticles(result.articles || []);
  } catch (e) { alert('âŒ ' + e.message); }
  setBtn(btn, false);
}

async function aiGenerateFromKB() {
  const checks = document.querySelectorAll('input[name="kbIds"]:checked');
  if (!checks.length) return alert('SÃ©lectionnez au moins une entrÃ©e de la base de connaissances.');
  const kbIds = Array.from(checks).map(cb => parseInt(cb.value));
  const outputLang = document.getElementById('kbOutputLang')?.value || 'source';
  const btn = document.getElementById('aiGenBtn3');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/generate-from-kb', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ kbIds, company_id: currentCompanyId, output_lang: outputLang })
    });
    const data = await res.json();
    if (!data.ok || !data.jobId) throw new Error(data.error || 'Erreur');
    const result = await pollJob(data.jobId);
    showArticles(result.articles || []);
  } catch (e) { alert('âŒ ' + e.message); }
  setBtn(btn, false);
}

async function diagKB() {
  const checks = document.querySelectorAll('input[name="kbIds"]:checked');
  if (!checks.length) return alert('SÃ©lectionnez au moins une entrÃ©e.');
  const kbIds = Array.from(checks).map(cb => parseInt(cb.value));
  const btn = document.getElementById('diagBtn');
  const result = document.getElementById('diagResult');
  setBtn(btn, true);
  try {
    const res = await fetch('/admin/articles/ai/diagnose-kb', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ kbIds })
    });
    const data = await res.json();
    if (!data.ok) throw new Error('Erreur');
    let html = '';
    data.diagnosis.forEach(d => {
      const stratList = Object.entries(d.strategies).map(([k,v]) => `<span style="color:${v > 3 ? '#10b981' : v > 1 ? '#f59e0b' : '#6b7280'}">${k}:${v}</span>`).join(' Â· ');
      const quality = d.bestSections >= 10 ? 'ğŸŸ¢' : d.bestSections >= 5 ? 'ğŸŸ¡' : 'ğŸ”´';
      const markers = [];
      if (d.hasMarkdownHeaders) markers.push('âœ… ##');
      else markers.push('âŒ ##');
      if (d.hasNumberedSections) markers.push('âœ… 1.');
      else markers.push('âŒ 1.');
      if (d.hasBoldHeaders) markers.push('âœ… **');
      else markers.push('âŒ **');

      html += `<div style="margin-bottom:0.75rem;padding-bottom:0.75rem;border-bottom:1px solid var(--border)">
        <strong>${quality} ${d.title}</strong> â€” ${d.chars} chars<br>
        Marqueurs: ${markers.join(' ')}${!d.hasMarkdownHeaders && !d.hasBoldHeaders ? ' <span style="color:#ef4444">âš ï¸ Pas de structure markdown â€” <strong>re-scrapez l\'URL</strong> dans la KB</span>' : ''}<br>
        StratÃ©gies: ${stratList}<br>
        â†’ <strong style="color:#10b981">${d.bestStrategy}</strong>: ${d.bestSections} sections â†’ ${d.estimatedBatches} batches â†’ <strong>~${d.estimatedArticles} articles estimÃ©s</strong><br>
        <details><summary style="cursor:pointer;color:var(--text-secondary)">AperÃ§u sections</summary>
          <div style="margin-top:0.25rem;font-size:0.8rem;color:var(--text-secondary)">
            ${d.sectionPreviews.map((p, i) => `${i+1}. ${p.replace(/</g, '&lt;')}`).join('<br>')}
          </div>
        </details>
      </div>`;
    });
    result.innerHTML = html;
    result.style.display = 'block';
  } catch (e) { alert('âŒ ' + e.message); }
  setBtn(btn, false);
}

// On modal overlay click
document.getElementById('aiModal')?.addEventListener('click', function(e) { if (e.target === this) closeModal('aiModal'); });

function toggleAllKb() {
  const checked = document.getElementById('kbSelectAll').checked;
  document.querySelectorAll('input[name="kbIds"]').forEach(cb => cb.checked = checked);
}

// â”€â”€â”€ Translate single article â”€â”€â”€
async function translateArticle(id) {
  const btn = document.getElementById('transBtn' + id);
  if (!btn) return;
  btn.textContent = 'â³';
  btn.disabled = true;
  try {
    const res = await fetch('/admin/articles/' + id + '/translate', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}'
    });
    const data = await res.json();
    if (data.jobId) {
      // Poll for completion
      const poll = async () => {
        const r = await fetch('/admin/articles/ai/job/' + data.jobId + '?t=' + Date.now());
        const job = await r.json();
        if (job.status === 'done') { btn.textContent = 'âœ…'; setTimeout(() => location.reload(), 800); return; }
        if (job.status === 'error') { btn.textContent = 'âŒ'; alert('Erreur: ' + job.error); return; }
        setTimeout(poll, 2000);
      };
      poll();
    } else {
      btn.textContent = 'âœ…';
      alert(data.message || 'Traduit !');
    }
  } catch (e) { btn.textContent = 'âŒ'; alert('Erreur: ' + e.message); }
}
// â•â•â• Bulk Category Actions â•â•â•
function toggleSelectAll(el) {
  document.querySelectorAll('.article-check').forEach(cb => cb.checked = el.checked);
  updateBulkBar();
}
function updateBulkBar() {
  const checked = document.querySelectorAll('.article-check:checked');
  const bar = document.getElementById('bulkBar');
  if (checked.length > 0) {
    bar.style.display = 'flex';
    document.getElementById('bulkCount').textContent = checked.length + ' sÃ©lectionnÃ©(s)';
  } else {
    bar.style.display = 'none';
  }
}
function clearSelection() {
  document.querySelectorAll('.article-check').forEach(cb => cb.checked = false);
  document.getElementById('selectAll').checked = false;
  updateBulkBar();
}
async function applyBulkCategory() {
  const catId = document.getElementById('bulkCategory').value;
  if (!catId) return alert('SÃ©lectionnez une catÃ©gorie');
  const ids = [...document.querySelectorAll('.article-check:checked')].map(cb => cb.value);
  if (ids.length === 0) return;
  if (!confirm('Changer la catÃ©gorie de ' + ids.length + ' article(s) ?')) return;
  try {
    const res = await fetch('/admin/articles/bulk-category', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ article_ids: ids, category_id: catId })
    });
    const data = await res.json();
    if (data.ok) location.reload();
    else alert('Erreur: ' + (data.error || 'Inconnu'));
  } catch (e) { alert('Erreur: ' + e.message); }
}
</script>

<%- include('../partials/foot') %>
