<%- include('../partials/head') %>

<div class="page-header">
  <div>
    <h1 class="page-title"><%= t.kb_title %></h1>
    <p class="page-subtitle"><%= entries.length %> <%= t.kb_count %></p>
  </div>
</div>

<% if (typeof flash !== 'undefined' && flash) { %>
  <div class="alert alert-<%= flash.type === 'success' ? 'success' : 'error' %>" style="margin-bottom:1rem">
    <% if (flash.type === 'success') { %>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    <% } else { %>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    <% } %>
    <%= flash.msg %>
  </div>
<% } %>

<% if (!aiConfigured) { %>
  <div class="alert alert-info" style="margin-bottom:1.5rem">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
    <%= t.kb_ai_hint %>
  </div>
<% } %>

<!-- Add Knowledge Tabs -->
<div class="kb-add-section">
  <div class="kb-tabs">
    <button class="kb-tab active" onclick="switchKbTab('text')">ğŸ“ <%= t.kb_add_text %></button>
    <button class="kb-tab" onclick="switchKbTab('url')">ğŸŒ <%= t.kb_add_url %></button>
    <button class="kb-tab" onclick="switchKbTab('file')">ğŸ“ <%= t.kb_add_file %></button>
  </div>

  <!-- Text Input -->
  <div class="kb-tab-content active" id="kbTabText">
    <form method="POST" action="/admin/knowledge/add-text" class="kb-form">
      <div class="form-row">
        <div class="form-group form-group-lg">
          <label><%= t.kb_entry_title %></label>
          <input type="text" name="title" required placeholder="<%= t.kb_title_placeholder %>">
        </div>
      </div>
      <div class="form-group">
        <label><%= t.kb_entry_content %></label>
        <textarea name="content" rows="5" required placeholder="<%= t.kb_content_placeholder %>"></textarea>
      </div>
      <button type="submit" class="btn btn-primary"><%= t.kb_add_btn %></button>
    </form>
  </div>

  <!-- URL Input â€” Single + Bulk -->
  <div class="kb-tab-content" id="kbTabUrl">
    <div class="kb-url-modes">
      <button class="kb-url-mode active" onclick="switchUrlMode('single')">ğŸ”— <%= t.kb_url_single %></button>
      <button class="kb-url-mode" onclick="switchUrlMode('bulk')">ğŸ“‹ <%= t.kb_url_bulk %></button>
    </div>

    <!-- Single URL -->
    <div id="urlModeSingle" class="kb-form">
      <div class="form-group">
        <label><%= t.kb_url_label %></label>
        <input type="url" id="singleUrl" placeholder="https://example.com/page">
      </div>
      <div class="form-group">
        <label><%= t.kb_url_title %></label>
        <input type="text" id="singleUrlTitle" placeholder="<%= t.kb_url_title_placeholder %>">
      </div>
      <p class="text-muted text-sm"><%= t.kb_url_hint %></p>
      <button type="button" class="btn btn-primary" id="singleUrlBtn" onclick="importSingleUrl()"><%= t.kb_import_btn %></button>
    </div>

    <!-- Bulk URLs -->
    <div id="urlModeBulk" class="kb-form" style="display:none">
      <div class="form-group">
        <label><%= t.kb_url_bulk_label %></label>
        <textarea id="bulkUrls" rows="6" placeholder="https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3&#10;..."></textarea>
        <span class="form-hint"><%= t.kb_url_bulk_hint %></span>
      </div>
      <button type="button" class="btn btn-primary" id="bulkImportBtn" onclick="importBulkUrls()"><%= t.kb_import_bulk_btn %></button>
    </div>

    <!-- Progress Area -->
    <div id="urlProgress" style="display:none; margin-top:1rem;">
      <div class="kb-progress-header">
        <span id="urlProgressText"></span>
        <span id="urlProgressCount"></span>
      </div>
      <div class="kb-progress-bar">
        <div class="kb-progress-fill" id="urlProgressFill" style="width:0%"></div>
      </div>
      <div class="kb-progress-log" id="urlProgressLog"></div>
    </div>
  </div>

  <!-- File Upload -->
  <div class="kb-tab-content" id="kbTabFile">
    <form method="POST" action="/admin/knowledge/add-file" enctype="multipart/form-data" class="kb-form">
      <div class="form-group">
        <label><%= t.kb_file_label %></label>
        <input type="file" name="file" required accept=".txt,.md,.csv,.json,.png,.jpg,.jpeg,.gif,.webp,.pdf">
        <span class="form-hint"><%= t.kb_file_hint %></span>
      </div>
      <div class="form-group">
        <label><%= t.kb_entry_title %></label>
        <input type="text" name="title" placeholder="<%= t.kb_file_title_placeholder %>">
      </div>
      <div class="form-group">
        <label><%= t.kb_file_instruction %></label>
        <input type="text" name="instruction" placeholder="<%= t.kb_file_instruction_placeholder %>">
      </div>
      <button type="submit" class="btn btn-primary"><%= t.kb_import_btn %></button>
    </form>
  </div>
</div>

<!-- Knowledge Base Entries -->
<div class="kb-entries">
  <h3><%= t.kb_existing %></h3>
  <% entries.forEach(entry => { %>
    <div class="kb-entry <%= entry.is_active ? '' : 'kb-inactive' %>">
      <div class="kb-entry-header">
        <div class="kb-entry-meta">
          <span class="kb-source-badge kb-source-<%= entry.source_type %>">
            <%= entry.source_type === 'text' ? 'ğŸ“' : entry.source_type === 'url' ? 'ğŸŒ' : entry.source_type === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ“' %>
            <%= entry.source_type %>
          </span>
          <strong><%= entry.title %></strong>
        </div>
        <div class="kb-entry-actions">
          <span class="text-muted text-sm"><%= entry.author_name %> Â· <%= new Date(entry.created_at).toLocaleDateString(dateLocale) %></span>
          <form method="POST" action="/admin/knowledge/<%= entry.id %>/toggle" style="display:inline">
            <button type="submit" class="btn btn-xs btn-ghost" title="<%= entry.is_active ? t.kb_disable : t.kb_enable %>">
              <%= entry.is_active ? 'âœ…' : 'âŒ' %>
            </button>
          </form>
          <button class="btn btn-xs btn-ghost" onclick="toggleEditKb(<%= entry.id %>)">âœï¸</button>
          <% if (entry.source_type === 'url') { %>
            <button class="btn btn-xs btn-ghost" title="Re-scraper l'URL" id="rescrapeBtn<%= entry.id %>"
                    onclick="rescrapeKb(<%= entry.id %>)">ğŸ”„</button>
          <% } %>
          <form method="POST" action="/admin/knowledge/<%= entry.id %>/delete" style="display:inline"
                onsubmit="return confirm('<%= t.kb_delete_confirm %>')">
            <button type="submit" class="btn btn-xs btn-ghost">ğŸ—‘ï¸</button>
          </form>
        </div>
      </div>

      <div class="kb-entry-content"><%= entry.content.substring(0, 300) %><%= entry.content.length > 300 ? '...' : '' %> <span class="text-muted text-sm">(<%= (entry.content.length / 1000).toFixed(1) %>K chars)</span></div>

      <% if (entry.source_ref) { %>
        <div class="kb-entry-source">
          <% if (entry.source_type === 'url') { %>
            ğŸ”— <a href="<%= entry.source_ref %>" target="_blank"><%= entry.source_ref %></a>
          <% } else { %>
            ğŸ“„ <%= entry.source_ref %>
          <% } %>
        </div>
      <% } %>

      <!-- Edit form (hidden) -->
      <form method="POST" action="/admin/knowledge/<%= entry.id %>/update" class="kb-edit-form" id="kbEdit<%= entry.id %>" style="display:none">
        <div class="form-group">
          <input type="text" name="title" value="<%= entry.title %>">
        </div>
        <div class="form-group">
          <textarea name="content" rows="4"><%= entry.content %></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEditKb(<%= entry.id %>)"><%= t.cancel %></button>
          <button type="submit" class="btn btn-primary btn-sm"><%= t.save %></button>
        </div>
      </form>
    </div>
  <% }) %>
  <% if (entries.length === 0) { %>
    <div class="kb-empty"><%= t.kb_empty %></div>
  <% } %>
</div>

<script>
function switchKbTab(tab) {
  document.querySelectorAll('.kb-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.kb-tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('kbTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}
function switchUrlMode(mode) {
  document.querySelectorAll('.kb-url-mode').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('urlModeSingle').style.display = mode === 'single' ? 'block' : 'none';
  document.getElementById('urlModeBulk').style.display = mode === 'bulk' ? 'block' : 'none';
}
function toggleEditKb(id) {
  const el = document.getElementById('kbEdit' + id);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
// Loading state on form submit
document.querySelectorAll('.kb-form[action]').forEach(form => {
  form.addEventListener('submit', function() {
    const btn = form.querySelector('button[type="submit"]');
    if (btn) { btn.disabled = true; btn.textContent = '<%= t.kb_loading %>'; }
  });
});

// â”€â”€â”€ Progress UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showProgress() {
  document.getElementById('urlProgress').style.display = 'block';
  document.getElementById('urlProgressLog').innerHTML = '';
  document.getElementById('urlProgressFill').style.width = '0%';
}
function updateProgress(current, total, msg, status) {
  const pct = Math.round((current / total) * 100);
  document.getElementById('urlProgressFill').style.width = pct + '%';
  document.getElementById('urlProgressCount').textContent = current + '/' + total;
  document.getElementById('urlProgressText').textContent = '<%= t.kb_importing %>...';

  const log = document.getElementById('urlProgressLog');
  const icon = status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸';
  log.innerHTML += '<div class="kb-log-item kb-log-' + status + '">' + icon + ' ' + msg + '</div>';
  log.scrollTop = log.scrollHeight;
}
function endProgress(successCount, total) {
  document.getElementById('urlProgressText').textContent = '<%= t.kb_import_done %>';
  document.getElementById('urlProgressCount').textContent = successCount + '/' + total + ' âœ…';
  if (successCount > 0) {
    setTimeout(() => window.location.reload(), 1500);
  }
}

// â”€â”€â”€ Single URL Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function importSingleUrl() {
  const url = document.getElementById('singleUrl').value.trim();
  if (!url) return;

  const btn = document.getElementById('singleUrlBtn');
  btn.disabled = true; btn.textContent = '<%= t.kb_loading %>';
  showProgress();
  updateProgress(0, 1, url + ' â€” <%= t.kb_fetching %>...', 'pending');

  try {
    const res = await fetch('/admin/knowledge/import-single-url', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });

    // Guard against HTML error responses
    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('json')) {
      throw new Error('Erreur serveur (code ' + res.status + ')');
    }

    const data = await res.json();
    if (data.jobId) {
      // Poll for completion
      const poll = async () => {
        const r = await fetch('/admin/knowledge/job/' + data.jobId);
        const job = await r.json();
        if (job.status === 'done') {
          const result = job.result;
          updateProgress(1, 1, url + ' â€” ' + result.chars + ' chars (' + result.method + ')', 'success');
          endProgress(1, 1);
          btn.disabled = false; btn.textContent = '<%= t.kb_import_btn %>';
          return;
        }
        if (job.status === 'error') {
          updateProgress(1, 1, url + ' â€” ' + job.error, 'error');
          endProgress(0, 1);
          btn.disabled = false; btn.textContent = '<%= t.kb_import_btn %>';
          return;
        }
        setTimeout(poll, 2000);
      };
      poll();
      return;
    }
    updateProgress(1, 1, url + ' â€” ' + (data.error || 'Erreur'), 'error');
    endProgress(0, 1);
  } catch (e) {
    updateProgress(1, 1, url + ' â€” ' + e.message, 'error');
    endProgress(0, 1);
  }

  btn.disabled = false; btn.textContent = '<%= t.kb_import_btn %>';
}

// â”€â”€â”€ Bulk URL Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function importBulkUrls() {
  const text = document.getElementById('bulkUrls').value.trim();
  const urls = text.split(/[\n\r]+/).map(u => u.trim()).filter(u => u && (u.startsWith('http://') || u.startsWith('https://')));

  if (urls.length === 0) { alert('<%= t.kb_url_bulk_none %>'); return; }
  if (urls.length > 50) { alert('<%= t.kb_url_bulk_max %>'); return; }

  const btn = document.getElementById('bulkImportBtn');
  btn.disabled = true; btn.textContent = '<%= t.kb_loading %>';
  showProgress();
  document.getElementById('urlProgressText').textContent = '<%= t.kb_importing %> 0/' + urls.length;

  let successCount = 0;

  // Helper: wait for job to complete
  async function waitForJob(jobId, maxWait = 120000) {
    const start = Date.now();
    while (Date.now() - start < maxWait) {
      const r = await fetch('/admin/knowledge/job/' + jobId);
      const job = await r.json();
      if (job.status === 'done') return { ok: true, result: job.result };
      if (job.status === 'error') return { ok: false, error: job.error };
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    return { ok: false, error: 'Timeout' };
  }

  for (let i = 0; i < urls.length; i++) {
    const url = urls[i];
    try {
      document.getElementById('urlProgressText').textContent = '<%= t.kb_importing %> ' + (i+1) + '/' + urls.length;
      const res = await fetch('/admin/knowledge/import-single-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      if (data.jobId) {
        const result = await waitForJob(data.jobId);
        if (result.ok) {
          updateProgress(i + 1, urls.length, url + ' â€” ' + result.result.chars + ' chars (' + result.result.method + ')', 'success');
          successCount++;
        } else {
          updateProgress(i + 1, urls.length, url + ' â€” ' + result.error, 'error');
        }
      } else {
        updateProgress(i + 1, urls.length, url + ' â€” ' + (data.error || 'Erreur'), 'error');
      }
    } catch (e) {
      updateProgress(i + 1, urls.length, url + ' â€” ' + e.message, 'error');
    }
  }

  endProgress(successCount, urls.length);
  btn.disabled = false; btn.textContent = '<%= t.kb_import_bulk_btn %>';
}

// â”€â”€â”€ Re-scrape KB Entry (async with polling) â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rescrapeKb(id) {
  const btn = document.getElementById('rescrapeBtn' + id);
  if (!btn) return;
  btn.textContent = 'â³'; btn.disabled = true;

  try {
    const res = await fetch('/admin/knowledge/' + id + '/rescrape', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}'
    });

    // Check if response is JSON (not HTML error page)
    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('json')) {
      throw new Error('Erreur serveur (code ' + res.status + '). Rechargez la page et rÃ©essayez.');
    }

    const data = await res.json();
    if (!data.jobId) { btn.textContent = 'âŒ'; alert(data.error || 'Erreur'); btn.disabled = false; return; }

    // Poll
    const poll = async () => {
      try {
        const r = await fetch('/admin/knowledge/job/' + data.jobId);
        const job = await r.json();
        if (job.status === 'done') {
          btn.textContent = 'âœ…';
          alert('Re-scrapÃ©: ' + job.result.chars + ' chars (avant: ' + job.result.oldChars + ')');
          setTimeout(() => location.reload(), 500);
          return;
        }
        if (job.status === 'error') { btn.textContent = 'âŒ'; alert('Erreur: ' + job.error); btn.disabled = false; return; }
        setTimeout(poll, 2000);
      } catch (pollErr) { btn.textContent = 'âŒ'; alert('Erreur polling: ' + pollErr.message); btn.disabled = false; }
    };
    poll();
  } catch (e) { btn.textContent = 'âŒ'; alert(e.message); btn.disabled = false; }
}
</script>

<%- include('../partials/foot') %>
